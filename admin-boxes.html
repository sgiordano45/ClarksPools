<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boxes Pools Admin | GridironPools</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Roboto+Condensed:wght@300;400;700&family=Bebas+Neue&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="admin-common.css">
    <style>
        /* Boxes-specific styles */
        .boxes-stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .boxes-stat-card {
            background: var(--secondary-dark);
            border: 1px solid var(--card-border);
            border-radius: 10px;
            padding: 1.25rem;
            text-align: center;
        }

        .boxes-stat-card .stat-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .boxes-stat-card .stat-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.75rem;
        }

        .boxes-stat-card .stat-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Score Entry Card */
        .score-entry-card {
            background: var(--tertiary-dark);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .score-entry-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            background: var(--secondary-dark);
            border-bottom: 1px solid var(--card-border);
        }

        .score-entry-teams {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .score-entry-team {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .score-entry-team .team-logo {
            width: 36px;
            height: 36px;
            background: var(--tertiary-dark);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .score-entry-team .team-name {
            font-family: 'Oswald', sans-serif;
            font-weight: 600;
            font-size: 1rem;
        }

        .score-entry-vs {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .score-entry-label {
            padding: 0.35rem 0.75rem;
            border-radius: 50px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            background: rgba(0,212,255,0.15);
            color: var(--accent-blue);
        }

        .score-entry-body {
            padding: 1.5rem;
        }

        .score-inputs-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 1.5rem;
            align-items: end;
            margin-bottom: 1.5rem;
        }

        .team-scores {
            display: flex;
            gap: 0.75rem;
        }

        .score-input-box {
            text-align: center;
        }

        .score-input-box label {
            display: block;
            font-size: 0.65rem;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 0.35rem;
            letter-spacing: 0.5px;
        }

        .score-input-box input {
            width: 55px;
            padding: 0.6rem;
            text-align: center;
            background: var(--secondary-dark);
            border: 1px solid var(--card-border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.25rem;
        }

        .score-input-box input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .score-divider {
            font-size: 1.5rem;
            color: var(--text-muted);
            padding-bottom: 0.5rem;
        }

        /* Winner Preview Grid */
        .winner-preview-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .winner-preview-item {
            background: var(--secondary-dark);
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
            border: 1px solid var(--card-border);
            transition: all 0.2s ease;
        }

        .winner-preview-item.has-winner {
            border-color: var(--accent-green);
            background: rgba(0,200,83,0.05);
        }

        .winner-preview-item .period {
            font-size: 0.65rem;
            text-transform: uppercase;
            color: var(--text-muted);
            letter-spacing: 1px;
            margin-bottom: 0.25rem;
        }

        .winner-preview-item .score {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.35rem;
            color: var(--accent-blue);
        }

        .winner-preview-item .box {
            font-family: 'Oswald', sans-serif;
            font-size: 0.9rem;
            color: var(--accent-gold);
            margin: 0.25rem 0;
        }

        .winner-preview-item .owner {
            font-size: 0.75rem;
            color: var(--accent-green);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .winner-preview-item .owner.unclaimed {
            color: var(--text-muted);
        }

        .score-entry-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* Leaderboard Styles */
        .leaderboard-rank {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.25rem;
        }

        .leaderboard-rank.gold { color: var(--accent-gold); }
        .leaderboard-rank.silver { color: #c0c0c0; }
        .leaderboard-rank.bronze { color: #cd7f32; }

        .win-badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-right: 0.25rem;
        }

        .win-badge.q1 { background: rgba(255,82,82,0.2); color: var(--accent-red); }
        .win-badge.half { background: rgba(168,85,247,0.2); color: var(--accent-purple); }
        .win-badge.q3 { background: rgba(0,200,83,0.2); color: var(--accent-green); }
        .win-badge.final { background: rgba(255,193,7,0.2); color: var(--accent-gold); }

        .winnings-amount {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.1rem;
            color: var(--accent-green);
        }

        @media (max-width: 1400px) {
            .boxes-stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 992px) {
            .score-inputs-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .score-divider {
                display: none;
            }
            
            .winner-preview-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="home.html" class="logo">
                    <div class="logo-icon">GP</div>
                    <div class="logo-text">Gridiron<span>Pools</span></div>
                </a>
                <span class="admin-badge">Admin</span>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Admin Pages</div>
                    <a class="nav-item" href="admin.html">
                        <span class="icon">üìä</span>
                        Dashboard
                    </a>
                    <a class="nav-item" href="admin-data.html">
                        <span class="icon">üì•</span>
                        Data Manager
                    </a>
                    <a class="nav-item" href="admin-betting.html">
                        <span class="icon">üí∞</span>
                        Betting Pools
                    </a>
                    <a class="nav-item active" href="admin-boxes.html">
                        <span class="icon">üé≤</span>
                        Boxes Pools
                    </a>
                </div>

                <div class="nav-divider"></div>

                <div class="nav-section">
                    <div class="nav-section-title">Boxes Management</div>
                    <a class="nav-item active" data-section="overview">
                        <span class="icon">üìã</span>
                        All Pools
                    </a>
                    <a class="nav-item" data-section="scores">
                        <span class="icon">üìù</span>
                        Update Scores
                    </a>
                    <a class="nav-item" data-section="leaderboard">
                        <span class="icon">üèÜ</span>
                        Leaderboard
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="adminAvatar">--</div>
                    <div class="user-details">
                        <div class="user-name" id="adminName">Loading...</div>
                        <div class="user-role">Commissioner</div>
                    </div>
                </div>
                <a href="#" onclick="handleLogout()" style="display: block; margin-top: 0.75rem; font-size: 0.85rem; color: var(--text-secondary); text-decoration: none;">
                    ‚Üê Sign Out
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Overview Section -->
            <section class="content-section active" id="overview">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">üé≤ Boxes Pools</h1>
                        <p class="page-subtitle">Manage Super Bowl Boxes, March Madness, and other boxes pools</p>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <a href="boxes-pool.html" class="btn btn-primary">
                            <span>üé≤</span> Open Boxes Page
                        </a>
                        <button class="btn btn-outline" onclick="loadBoxesPools()">
                            <span>üîÑ</span> Refresh
                        </button>
                    </div>
                </div>

                <div class="boxes-stats-grid">
                    <div class="boxes-stat-card">
                        <div class="stat-icon">üìã</div>
                        <div class="stat-value" id="statTotalPools">0</div>
                        <div class="stat-label">Total Pools</div>
                    </div>
                    <div class="boxes-stat-card">
                        <div class="stat-icon">üéØ</div>
                        <div class="stat-value" id="statTotalClaimed">0</div>
                        <div class="stat-label">Boxes Claimed</div>
                    </div>
                    <div class="boxes-stat-card">
                        <div class="stat-icon">üíµ</div>
                        <div class="stat-value" style="color: var(--accent-green);" id="statTotalPrize">$0</div>
                        <div class="stat-label">Total Prize Pool</div>
                    </div>
                    <div class="boxes-stat-card">
                        <div class="stat-icon">üîí</div>
                        <div class="stat-value" id="statLockedPools">0</div>
                        <div class="stat-label">Locked Pools</div>
                    </div>
                    <div class="boxes-stat-card">
                        <div class="stat-icon">üèÜ</div>
                        <div class="stat-value" style="color: var(--accent-gold);" id="statTotalWinners">0</div>
                        <div class="stat-label">Winners Paid</div>
                    </div>
                </div>

                <div class="data-card">
                    <div class="data-card-header">
                        <h3 class="data-card-title">All Boxes Pools</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Pool Name</th>
                                <th>Sport</th>
                                <th>Boxes</th>
                                <th>Prize Pool</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="poolsTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-muted);">Loading pools...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Update Scores Section -->
            <section class="content-section" id="scores">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">üìù Update Scores</h1>
                        <p class="page-subtitle">Enter game scores to automatically calculate winning boxes</p>
                    </div>
                </div>

                <div class="data-card">
                    <div class="data-card-header">
                        <h3 class="data-card-title">Select Pool</h3>
                    </div>
                    <div style="padding: 1rem 1.5rem;">
                        <select class="form-control" id="scorePoolSelect" onchange="loadPoolForScoring()" style="max-width: 400px;">
                            <option value="">-- Select a boxes pool --</option>
                        </select>
                    </div>
                </div>

                <div id="scoresContainer" style="display: none;">
                    <!-- Games will be rendered here -->
                </div>
            </section>

            <!-- Leaderboard Section -->
            <section class="content-section" id="leaderboard">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">üèÜ Leaderboard</h1>
                        <p class="page-subtitle">View winners and payouts across all boxes pools</p>
                    </div>
                </div>

                <div class="data-card">
                    <div class="data-card-header">
                        <h3 class="data-card-title">Select Pool</h3>
                    </div>
                    <div style="padding: 1rem 1.5rem;">
                        <select class="form-control" id="leaderboardPoolSelect" onchange="loadLeaderboard()" style="max-width: 400px;">
                            <option value="">-- Select a boxes pool --</option>
                        </select>
                    </div>
                </div>

                <div id="leaderboardContainer" style="display: none;">
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title" id="leaderboardPoolName">Pool Leaderboard</h3>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Name</th>
                                    <th>Wins</th>
                                    <th>Boxes Owned</th>
                                    <th>Winnings</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboardTableBody">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-muted);">No winners yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    
    <script>
        let currentUser = null;
        let currentPool = null;
        let allPools = [];
        
        // Sport config
        const sportConfig = {
            nfl: { emoji: 'üèà', name: 'NFL Football' },
            ncaa_basketball: { emoji: 'üèÄ', name: 'College Basketball' },
            nba: { emoji: 'üèÄ', name: 'NBA' },
            nhl: { emoji: 'üèí', name: 'NHL Hockey' },
            mlb: { emoji: '‚öæ', name: 'MLB Baseball' },
            soccer: { emoji: '‚öΩ', name: 'Soccer' },
            other: { emoji: 'üé≤', name: 'Other' }
        };
        
        function getSportEmoji(sport) {
            return sportConfig[sport]?.emoji || 'üé≤';
        }
        
        function getSportName(sport) {
            return sportConfig[sport]?.name || 'Sports';
        }
        
        // Auth check - listen for custom event from firebase-config.js
        window.addEventListener('userLoggedIn', async (e) => {
            const { user, userData } = e.detail;
            console.log('Boxes Admin: User logged in', user.email, 'Role:', userData?.role);
            
            if (!userData || userData.role !== 'admin') {
                alert('Access denied. Admin privileges required.');
                window.location.href = 'home.html';
                return;
            }
            
            currentUser = user;
            document.getElementById('adminName').textContent = userData.displayName || user.email;
            document.getElementById('adminAvatar').textContent = getUserInitials(userData.displayName || user.email);
            
            await loadBoxesPools();
        });
        
        window.addEventListener('userLoggedOut', () => {
            console.log('Boxes Admin: User logged out, redirecting');
            window.location.href = 'home.html';
        });
        
        function handleLogout() {
            signOut().then(() => { window.location.href = 'home.html'; });
        }
        
        // Navigation
        document.querySelectorAll('.nav-item[data-section]').forEach(item => {
            item.addEventListener('click', () => {
                const section = item.dataset.section;
                showSection(section);
            });
        });
        
        function showSection(sectionId) {
            document.querySelectorAll('.nav-item[data-section]').forEach(item => {
                item.classList.toggle('active', item.dataset.section === sectionId);
            });
            
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.toggle('active', section.id === sectionId);
            });
            
            if (sectionId === 'overview') {
                loadBoxesPools();
            }
        }
        
        // Load all boxes pools
        async function loadBoxesPools() {
            try {
                const snapshot = await db.collection('boxesPools').orderBy('createdAt', 'desc').get();
                allPools = [];
                
                let totalClaimed = 0;
                let totalPrize = 0;
                let lockedCount = 0;
                let winnersCount = 0;
                
                const tbody = document.getElementById('poolsTableBody');
                
                if (snapshot.empty) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                                No boxes pools created yet. <a href="boxes-pool.html" style="color: var(--accent-blue);">Create one</a>
                            </td>
                        </tr>
                    `;
                    updateStats(0, 0, 0, 0, 0);
                    return;
                }
                
                tbody.innerHTML = snapshot.docs.map(doc => {
                    const pool = { id: doc.id, ...doc.data() };
                    allPools.push(pool);
                    
                    const entries = pool.entries || {};
                    const claimed = Object.keys(entries).length;
                    const costPerBox = pool.costPerBox || 0;
                    const prize = claimed * costPerBox;
                    
                    totalClaimed += claimed;
                    totalPrize += prize;
                    if (pool.locked) lockedCount++;
                    
                    // Count winners
                    const games = pool.games || [];
                    games.forEach(game => {
                        const winners = game.winners || {};
                        ['q1', 'half', 'q3', 'final'].forEach(period => {
                            if (winners[period]?.box) winnersCount++;
                        });
                    });
                    
                    const emoji = getSportEmoji(pool.sport || 'nfl');
                    const sportName = getSportName(pool.sport || 'nfl');
                    const statusClass = pool.locked ? 'locked' : 'open';
                    const statusText = pool.locked ? 'Locked' : 'Open';
                    
                    return `
                        <tr>
                            <td>
                                <div style="font-weight: 600;">${emoji} ${pool.name || 'Unnamed Pool'}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">${pool.description || ''}</div>
                            </td>
                            <td>${sportName}</td>
                            <td>${claimed}/100</td>
                            <td style="font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem;">$${prize}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>
                                <div class="action-btns">
                                    <button class="action-btn" onclick="selectPoolForScoring('${doc.id}')" title="Update Scores">üìù</button>
                                    <button class="action-btn" onclick="selectPoolForLeaderboard('${doc.id}')" title="View Leaderboard">üèÜ</button>
                                    <a class="action-btn" href="boxes-pool.html?pool=${doc.id}" target="_blank" title="Open Pool">üîó</a>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                updateStats(allPools.length, totalClaimed, totalPrize, lockedCount, winnersCount);
                populatePoolSelects();
                
            } catch (error) {
                console.error('Error loading pools:', error);
                document.getElementById('poolsTableBody').innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: var(--accent-red);">Error loading pools</td>
                    </tr>
                `;
            }
        }
        
        function updateStats(pools, claimed, prize, locked, winners) {
            document.getElementById('statTotalPools').textContent = pools;
            document.getElementById('statTotalClaimed').textContent = claimed;
            document.getElementById('statTotalPrize').textContent = '$' + prize;
            document.getElementById('statLockedPools').textContent = locked;
            document.getElementById('statTotalWinners').textContent = winners;
        }
        
        function populatePoolSelects() {
            const options = '<option value="">-- Select a boxes pool --</option>' + 
                allPools.map(pool => {
                    const emoji = getSportEmoji(pool.sport || 'nfl');
                    return `<option value="${pool.id}">${emoji} ${pool.name || 'Unnamed Pool'}</option>`;
                }).join('');
            
            document.getElementById('scorePoolSelect').innerHTML = options;
            document.getElementById('leaderboardPoolSelect').innerHTML = options;
        }
        
        function selectPoolForScoring(poolId) {
            document.getElementById('scorePoolSelect').value = poolId;
            showSection('scores');
            loadPoolForScoring();
        }
        
        function selectPoolForLeaderboard(poolId) {
            document.getElementById('leaderboardPoolSelect').value = poolId;
            showSection('leaderboard');
            loadLeaderboard();
        }
        
        // Load pool for scoring
        async function loadPoolForScoring() {
            const poolId = document.getElementById('scorePoolSelect').value;
            const container = document.getElementById('scoresContainer');
            
            if (!poolId) {
                container.style.display = 'none';
                currentPool = null;
                return;
            }
            
            currentPool = allPools.find(p => p.id === poolId);
            if (!currentPool) {
                // Fetch from DB
                const doc = await db.collection('boxesPools').doc(poolId).get();
                if (doc.exists) {
                    currentPool = { id: poolId, ...doc.data() };
                }
            }
            
            if (!currentPool) {
                container.innerHTML = '<div class="alert alert-error">Pool not found</div>';
                container.style.display = 'block';
                return;
            }
            
            container.style.display = 'block';
            renderGamesForScoring();
        }
        
        function renderGamesForScoring() {
            const container = document.getElementById('scoresContainer');
            const games = currentPool.games || [];
            const emoji = getSportEmoji(currentPool.sport || 'nfl');
            
            if (games.length === 0) {
                container.innerHTML = `
                    <div class="data-card">
                        <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                            <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">No games configured for this pool</p>
                            <p><a href="boxes-pool.html?pool=${currentPool.id}" style="color: var(--accent-blue);">Add games in the Boxes Pool page</a></p>
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = games.map((game, idx) => {
                const scores = game.scores || { t1: {}, t2: {} };
                
                return `
                    <div class="score-entry-card">
                        <div class="score-entry-header">
                            <div class="score-entry-teams">
                                <div class="score-entry-team">
                                    <div class="team-logo">${emoji}</div>
                                    <div class="team-name">${game.team1 || 'Team 1'}</div>
                                </div>
                                <span class="score-entry-vs">vs</span>
                                <div class="score-entry-team">
                                    <div class="team-logo">${emoji}</div>
                                    <div class="team-name">${game.team2 || 'Team 2'}</div>
                                </div>
                            </div>
                            <span class="score-entry-label">${game.label || 'Game ' + (idx + 1)}</span>
                        </div>
                        <div class="score-entry-body">
                            <div class="score-inputs-grid">
                                <div>
                                    <label style="display: block; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.5rem;">${game.team1 || 'Team 1'} Scores</label>
                                    <div class="team-scores">
                                        <div class="score-input-box">
                                            <label>Q1</label>
                                            <input type="number" id="t1-q1-${idx}" value="${scores.t1?.q1 ?? ''}" min="0" onchange="updateWinnerPreview(${idx})">
                                        </div>
                                        <div class="score-input-box">
                                            <label>Q2</label>
                                            <input type="number" id="t1-q2-${idx}" value="${scores.t1?.q2 ?? ''}" min="0" onchange="updateWinnerPreview(${idx})">
                                        </div>
                                        <div class="score-input-box">
                                            <label>Q3</label>
                                            <input type="number" id="t1-q3-${idx}" value="${scores.t1?.q3 ?? ''}" min="0" onchange="updateWinnerPreview(${idx})">
                                        </div>
                                        <div class="score-input-box">
                                            <label>Final</label>
                                            <input type="number" id="t1-final-${idx}" value="${scores.t1?.final ?? ''}" min="0" onchange="updateWinnerPreview(${idx})">
                                        </div>
                                    </div>
                                </div>
                                <div class="score-divider">-</div>
                                <div>
                                    <label style="display: block; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.5rem;">${game.team2 || 'Team 2'} Scores</label>
                                    <div class="team-scores">
                                        <div class="score-input-box">
                                            <label>Q1</label>
                                            <input type="number" id="t2-q1-${idx}" value="${scores.t2?.q1 ?? ''}" min="0" onchange="updateWinnerPreview(${idx})">
                                        </div>
                                        <div class="score-input-box">
                                            <label>Q2</label>
                                            <input type="number" id="t2-q2-${idx}" value="${scores.t2?.q2 ?? ''}" min="0" onchange="updateWinnerPreview(${idx})">
                                        </div>
                                        <div class="score-input-box">
                                            <label>Q3</label>
                                            <input type="number" id="t2-q3-${idx}" value="${scores.t2?.q3 ?? ''}" min="0" onchange="updateWinnerPreview(${idx})">
                                        </div>
                                        <div class="score-input-box">
                                            <label>Final</label>
                                            <input type="number" id="t2-final-${idx}" value="${scores.t2?.final ?? ''}" min="0" onchange="updateWinnerPreview(${idx})">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="winner-preview-grid" id="preview-${idx}">
                                ${renderWinnerPreview(game, idx)}
                            </div>
                            
                            <div class="score-entry-actions">
                                <button class="btn btn-gold" onclick="saveGameScores(${idx})">
                                    <span>üíæ</span> Save Scores
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderWinnerPreview(game, idx) {
            const colNumbers = game.colNumbers || [0,1,2,3,4,5,6,7,8,9];
            const rowNumbers = game.rowNumbers || [0,1,2,3,4,5,6,7,8,9];
            const scores = game.scores || { t1: {}, t2: {} };
            const entries = currentPool.entries || {};
            
            const periods = [
                { key: 'q1', label: '1st Qtr', t1: scores.t1?.q1, t2: scores.t2?.q1 },
                { 
                    key: 'half', label: 'Halftime', 
                    t1: (scores.t1?.q1 !== undefined && scores.t1?.q2 !== undefined) ? (parseInt(scores.t1.q1) + parseInt(scores.t1.q2)) : undefined,
                    t2: (scores.t2?.q1 !== undefined && scores.t2?.q2 !== undefined) ? (parseInt(scores.t2.q1) + parseInt(scores.t2.q2)) : undefined
                },
                { 
                    key: 'q3', label: '3rd Qtr', 
                    t1: (scores.t1?.q1 !== undefined && scores.t1?.q2 !== undefined && scores.t1?.q3 !== undefined) ? 
                        (parseInt(scores.t1.q1) + parseInt(scores.t1.q2) + parseInt(scores.t1.q3)) : undefined,
                    t2: (scores.t2?.q1 !== undefined && scores.t2?.q2 !== undefined && scores.t2?.q3 !== undefined) ? 
                        (parseInt(scores.t2.q1) + parseInt(scores.t2.q2) + parseInt(scores.t2.q3)) : undefined
                },
                { key: 'final', label: 'Final', t1: scores.t1?.final, t2: scores.t2?.final }
            ];
            
            return periods.map(p => {
                if (p.t1 === undefined || p.t2 === undefined || p.t1 === '' || p.t2 === '') {
                    return `
                        <div class="winner-preview-item">
                            <div class="period">${p.label}</div>
                            <div class="score">-</div>
                            <div class="box">Awaiting</div>
                            <div class="owner unclaimed">Enter scores</div>
                        </div>
                    `;
                }
                
                const t1Digit = parseInt(p.t1) % 10;
                const t2Digit = parseInt(p.t2) % 10;
                const colIdx = colNumbers.indexOf(t1Digit);
                const rowIdx = rowNumbers.indexOf(t2Digit);
                
                if (colIdx === -1 || rowIdx === -1) {
                    return `
                        <div class="winner-preview-item">
                            <div class="period">${p.label}</div>
                            <div class="score">${p.t1}-${p.t2}</div>
                            <div class="box">Error</div>
                            <div class="owner unclaimed">Numbers not found</div>
                        </div>
                    `;
                }
                
                const boxKey = `${rowIdx}-${colIdx}`;
                const entry = entries[boxKey];
                const owner = entry?.name || 'Unclaimed';
                const hasWinner = !!entry;
                
                return `
                    <div class="winner-preview-item ${hasWinner ? 'has-winner' : ''}">
                        <div class="period">${p.label}</div>
                        <div class="score">${p.t1}-${p.t2}</div>
                        <div class="box">Box ${boxKey}</div>
                        <div class="owner ${hasWinner ? '' : 'unclaimed'}">${hasWinner ? 'üèÜ ' : ''}${owner}</div>
                    </div>
                `;
            }).join('');
        }
        
        function updateWinnerPreview(gameIdx) {
            const game = currentPool.games[gameIdx];
            
            // Read scores from inputs
            game.scores = {
                t1: {
                    q1: getInputValue(`t1-q1-${gameIdx}`),
                    q2: getInputValue(`t1-q2-${gameIdx}`),
                    q3: getInputValue(`t1-q3-${gameIdx}`),
                    final: getInputValue(`t1-final-${gameIdx}`)
                },
                t2: {
                    q1: getInputValue(`t2-q1-${gameIdx}`),
                    q2: getInputValue(`t2-q2-${gameIdx}`),
                    q3: getInputValue(`t2-q3-${gameIdx}`),
                    final: getInputValue(`t2-final-${gameIdx}`)
                }
            };
            
            document.getElementById(`preview-${gameIdx}`).innerHTML = renderWinnerPreview(game, gameIdx);
        }
        
        function getInputValue(id) {
            const val = document.getElementById(id)?.value;
            return val === '' ? undefined : parseInt(val);
        }
        
        async function saveGameScores(gameIdx) {
            if (!currentPool) return;
            
            const game = currentPool.games[gameIdx];
            const colNumbers = game.colNumbers || [0,1,2,3,4,5,6,7,8,9];
            const rowNumbers = game.rowNumbers || [0,1,2,3,4,5,6,7,8,9];
            
            // Read scores
            const scores = {
                t1: {
                    q1: getInputValue(`t1-q1-${gameIdx}`),
                    q2: getInputValue(`t1-q2-${gameIdx}`),
                    q3: getInputValue(`t1-q3-${gameIdx}`),
                    final: getInputValue(`t1-final-${gameIdx}`)
                },
                t2: {
                    q1: getInputValue(`t2-q1-${gameIdx}`),
                    q2: getInputValue(`t2-q2-${gameIdx}`),
                    q3: getInputValue(`t2-q3-${gameIdx}`),
                    final: getInputValue(`t2-final-${gameIdx}`)
                }
            };
            
            game.scores = scores;
            
            // Calculate winners
            const calculateBox = (t1, t2) => {
                if (t1 === undefined || t2 === undefined) return null;
                const colIdx = colNumbers.indexOf(t1 % 10);
                const rowIdx = rowNumbers.indexOf(t2 % 10);
                if (colIdx === -1 || rowIdx === -1) return null;
                return `${rowIdx}-${colIdx}`;
            };
            
            game.winners = {};
            
            // Q1
            if (scores.t1.q1 !== undefined && scores.t2.q1 !== undefined) {
                const box = calculateBox(scores.t1.q1, scores.t2.q1);
                if (box) game.winners.q1 = { box, score: `${scores.t1.q1}-${scores.t2.q1}` };
            }
            
            // Halftime
            if (scores.t1.q1 !== undefined && scores.t1.q2 !== undefined && scores.t2.q1 !== undefined && scores.t2.q2 !== undefined) {
                const t1Half = scores.t1.q1 + scores.t1.q2;
                const t2Half = scores.t2.q1 + scores.t2.q2;
                const box = calculateBox(t1Half, t2Half);
                if (box) game.winners.half = { box, score: `${t1Half}-${t2Half}` };
            }
            
            // Q3
            if (scores.t1.q1 !== undefined && scores.t1.q2 !== undefined && scores.t1.q3 !== undefined &&
                scores.t2.q1 !== undefined && scores.t2.q2 !== undefined && scores.t2.q3 !== undefined) {
                const t1Q3 = scores.t1.q1 + scores.t1.q2 + scores.t1.q3;
                const t2Q3 = scores.t2.q1 + scores.t2.q2 + scores.t2.q3;
                const box = calculateBox(t1Q3, t2Q3);
                if (box) game.winners.q3 = { box, score: `${t1Q3}-${t2Q3}` };
            }
            
            // Final
            if (scores.t1.final !== undefined && scores.t2.final !== undefined) {
                const box = calculateBox(scores.t1.final, scores.t2.final);
                if (box) game.winners.final = { box, score: `${scores.t1.final}-${scores.t2.final}` };
            }
            
            try {
                await db.collection('boxesPools').doc(currentPool.id).update({
                    games: currentPool.games,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('Scores and winners saved successfully!');
                
            } catch (error) {
                console.error('Error saving scores:', error);
                alert('Error saving scores: ' + error.message);
            }
        }
        
        // Leaderboard
        async function loadLeaderboard() {
            const poolId = document.getElementById('leaderboardPoolSelect').value;
            const container = document.getElementById('leaderboardContainer');
            
            if (!poolId) {
                container.style.display = 'none';
                return;
            }
            
            const pool = allPools.find(p => p.id === poolId) || 
                         (await db.collection('boxesPools').doc(poolId).get()).data();
            
            if (!pool) {
                container.innerHTML = '<div class="alert alert-error">Pool not found</div>';
                container.style.display = 'block';
                return;
            }
            
            container.style.display = 'block';
            document.getElementById('leaderboardPoolName').textContent = 
                `${getSportEmoji(pool.sport || 'nfl')} ${pool.name || 'Pool'} - Leaderboard`;
            
            renderLeaderboardTable(pool);
        }
        
        function renderLeaderboardTable(pool) {
            const entries = pool.entries || {};
            const games = pool.games || [];
            const costPerBox = pool.costPerBox || 0;
            const totalPrize = Object.keys(entries).length * costPerBox;
            const payouts = pool.payoutStructure || { q1: 0.25, half: 0.25, q3: 0.25, final: 0.25 };
            
            // Count boxes per person
            const boxCounts = {};
            Object.values(entries).forEach(entry => {
                const name = entry.name || 'Unknown';
                boxCounts[name] = (boxCounts[name] || 0) + 1;
            });
            
            // Collect winners
            const winnerData = {};
            
            games.forEach((game, gameIdx) => {
                const winners = game.winners || {};
                
                ['q1', 'half', 'q3', 'final'].forEach(period => {
                    const winner = winners[period];
                    if (winner?.box && entries[winner.box]) {
                        const name = entries[winner.box].name || 'Unknown';
                        
                        if (!winnerData[name]) {
                            winnerData[name] = { name, wins: [], totalWinnings: 0 };
                        }
                        
                        const payout = (totalPrize * (payouts[period] || 0.25)) / games.length;
                        winnerData[name].wins.push({ period, game: game.label || `Game ${gameIdx + 1}` });
                        winnerData[name].totalWinnings += payout;
                    }
                });
            });
            
            const leaderboard = Object.values(winnerData).sort((a, b) => 
                b.totalWinnings - a.totalWinnings || b.wins.length - a.wins.length
            );
            
            const tbody = document.getElementById('leaderboardTableBody');
            
            if (leaderboard.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                            No winners yet - check back after game scores are entered
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = leaderboard.map((player, idx) => {
                const rankClass = idx === 0 ? 'gold' : idx === 1 ? 'silver' : idx === 2 ? 'bronze' : '';
                const winBadges = player.wins.map(w => 
                    `<span class="win-badge ${w.period}">${w.period === 'half' ? 'H' : w.period.toUpperCase()}</span>`
                ).join('');
                
                return `
                    <tr>
                        <td><span class="leaderboard-rank ${rankClass}">${idx + 1}</span></td>
                        <td style="font-weight: 600;">${player.name}</td>
                        <td>${winBadges}</td>
                        <td>${boxCounts[player.name] || 0}</td>
                        <td><span class="winnings-amount">$${player.totalWinnings.toFixed(0)}</span></td>
                    </tr>
                `;
            }).join('');
        }
    </script>
</body>
</html>
