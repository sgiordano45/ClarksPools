<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | SportsPools</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Roboto+Condensed:wght@300;400;700&family=Bebas+Neue&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="admin-common.css">
    <style>
        /* Page-specific styles */
        .options-divider {
            display: flex;
            align-items: center;
            margin: 1.5rem 0;
            gap: 1rem;
        }
        .options-divider::before, .options-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--card-border);
        }
        .options-divider span {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
        }
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .checkbox-label input {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-blue);
        }
        .info-box {
            display: flex;
            gap: 1rem;
            padding: 1rem 1.25rem;
            background: rgba(0,212,255,0.05);
            border: 1px solid rgba(0,212,255,0.2);
            border-radius: 8px;
            margin-top: 1.5rem;
        }
        .info-box-icon { font-size: 1.5rem; }
        .info-box-content strong {
            display: block;
            margin-bottom: 0.25rem;
            color: var(--accent-blue);
        }
        .info-box-content p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        /* Sortable table styles */
        .sortable {
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
            white-space: nowrap;
        }
        .sortable:hover {
            background: rgba(255,255,255,0.05);
        }
        .sort-icon {
            opacity: 0.4;
            font-size: 0.75rem;
            margin-left: 0.25rem;
            display: inline-block;
        }
        .sortable.asc .sort-icon { opacity: 1; }
        .sortable.desc .sort-icon { opacity: 1; }
        .sortable.asc .sort-icon::before { content: '‚ñ≤'; }
        .sortable.desc .sort-icon::before { content: '‚ñº'; }
        .sortable:not(.asc):not(.desc) .sort-icon::before { content: '‚áÖ'; }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="home.html" class="logo">
                    <div class="logo-icon">SP</div>
                    <div class="logo-text">Sports<span>Pools</span></div>
                </a>
                <span class="admin-badge">Admin</span>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Overview</div>
                    <a class="nav-item active" data-section="dashboard">
                        <span class="icon">üìä</span>
                        Dashboard
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Fantasy Pools</div>
                    <a class="nav-item" data-section="pools">
                        <span class="icon">üèà</span>
                        All Pools
                    </a>
                    <a class="nav-item" data-section="create-pool">
                        <span class="icon">‚ûï</span>
                        Create Pool
                    </a>
                    <a class="nav-item" data-section="entries">
                        <span class="icon">üìù</span>
                        Entries
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Other Admin</div>
                    <a class="nav-item" href="admin-data.html">
                        <span class="icon">üì•</span>
                        Data Manager
                    </a>
                    <a class="nav-item" href="admin-betting.html">
                        <span class="icon">üí∞</span>
                        Betting Pools
                    </a>
                    <a class="nav-item" href="admin-boxes.html">
                        <span class="icon">üé≤</span>
                        Boxes Pools
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Users</div>
                    <a class="nav-item" data-section="users">
                        <span class="icon">üë•</span>
                        Manage Users
                    </a>
                    <a class="nav-item" data-section="payments">
                        <span class="icon">üíµ</span>
                        Payments
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="adminAvatar">--</div>
                    <div class="user-details">
                        <div class="user-name" id="adminName">Loading...</div>
                        <div class="user-role">Commissioner</div>
                    </div>
                </div>
                <a href="#" onclick="handleLogout()" style="display: block; margin-top: 0.75rem; font-size: 0.85rem; color: var(--text-secondary); text-decoration: none;">‚Üê Sign Out</a>
                <a href="home.html" style="display: block; margin-top: 0.5rem; font-size: 0.85rem; color: var(--accent-blue); text-decoration: none;">üè† Go Home</a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <section class="content-section active" id="dashboard">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Dashboard</h1>
                        <p class="page-subtitle">Welcome back! Here's what's happening with your pools.</p>
                    </div>
                    <button class="btn btn-primary" onclick="showSection('create-pool')"><span>+</span> Create Pool</button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Active Pools</div>
                        <div class="stat-value" id="statActivePools">--</div>
                        <div class="stat-change" id="statActivePoolsChange">Loading...</div>
                    </div>
                    <div class="stat-card gold">
                        <div class="stat-label">Total Entries</div>
                        <div class="stat-value" id="statTotalEntries">--</div>
                        <div class="stat-change" id="statEntriesChange">Loading...</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-label">Prize Pool</div>
                        <div class="stat-value" id="statPrizePool">--</div>
                        <div class="stat-change" id="statPrizeChange">Loading...</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-label">Pending Payments</div>
                        <div class="stat-value" id="statPendingPayments">--</div>
                        <div class="stat-change" id="statPaymentsChange">Loading...</div>
                    </div>
                </div>

                <div class="data-card">
                    <div class="data-card-header">
                        <h3 class="data-card-title">Your Pools</h3>
                        <button class="btn btn-outline btn-sm" onclick="showSection('pools')">View All</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr><th>Pool Name</th><th>Type</th><th>Entries</th><th>Prize Pool</th><th>Status</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="dashboardPoolsTable">
                            <tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-muted);">Loading pools...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Create Pool Section -->
            <section class="content-section" id="create-pool">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Create New Pool</h1>
                        <p class="page-subtitle">Set up a new playoff pool</p>
                    </div>
                </div>

                <div class="data-card">
                    <div class="data-card-header">
                        <h3 class="data-card-title">Pool Details</h3>
                    </div>
                    <div class="modal-body">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Pool Name *</label>
                                <input type="text" class="form-control" placeholder="e.g., Clarkside Pool 2025" id="poolName">
                            </div>
                            <div class="form-group">
                                <label>Pool Type *</label>
                                <select class="form-control" id="poolType" onchange="togglePoolTypeOptions()">
                                    <option value="playoff-fantasy">NFL Playoff Fantasy (14 Players)</option>
                                    <option value="betting-pool">Playoff Betting Pool (Spreads/ML)</option>
                                    <option value="boxes-pool">Super Bowl Boxes (10x10 Grid)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Buy-In Amount ($)</label>
                                <input type="number" class="form-control" placeholder="25" id="buyIn" value="25">
                            </div>
                            <div class="form-group">
                                <label>Payment Method</label>
                                <input type="text" class="form-control" placeholder="e.g., Venmo @YourHandle" id="paymentMethod">
                            </div>
                            <div class="form-group full-width">
                                <label>Pool Description (Optional)</label>
                                <textarea class="form-control" rows="3" placeholder="Add any additional rules or notes..." id="poolDescription"></textarea>
                            </div>
                        </div>

                        <!-- Fantasy Pool Options -->
                        <div id="fantasyOptions">
                            <div class="options-divider"><span>Fantasy Pool Settings</span></div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Entry Deadline</label>
                                    <input type="datetime-local" class="form-control" id="deadline">
                                </div>
                                <div class="form-group">
                                    <label>Max Entries Per User</label>
                                    <select class="form-control" id="maxEntries">
                                        <option value="1">1 Entry</option>
                                        <option value="2">2 Entries</option>
                                        <option value="3">3 Entries</option>
                                        <option value="0" selected>Unlimited</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <div class="toggle-group">
                                        <div class="toggle active" onclick="this.classList.toggle('active')" id="allowLateEntries"></div>
                                        <span class="toggle-label">Allow late entries</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="toggle-group">
                                        <div class="toggle" onclick="this.classList.toggle('active')" id="requirePayment"></div>
                                        <span class="toggle-label">Require payment before entry</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Betting Pool Options -->
                        <div id="bettingOptions" style="display: none;">
                            <div class="options-divider"><span>Betting Pool Settings</span></div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Starting Bankroll ($)</label>
                                    <input type="number" class="form-control" placeholder="1000" id="startingBankroll" value="1000">
                                </div>
                                <div class="form-group">
                                    <label>Min/Max Bet ($)</label>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input type="number" class="form-control" placeholder="10" id="minBet" value="10">
                                        <input type="number" class="form-control" placeholder="500" id="maxBet" value="500">
                                    </div>
                                </div>
                            </div>
                            <div class="info-box">
                                <div class="info-box-icon">üí°</div>
                                <div class="info-box-content">
                                    <strong>Note</strong>
                                    <p>For advanced betting management, use <a href="admin-betting.html" style="color: var(--accent-blue);">Betting Pools Admin</a> after creating.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Boxes Pool Options -->
                        <div id="boxesOptions" style="display: none;">
                            <div class="options-divider"><span>Super Bowl Boxes Settings</span></div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Cost Per Box ($)</label>
                                    <input type="number" class="form-control" placeholder="10" id="costPerBox" value="10">
                                </div>
                                <div class="form-group">
                                    <label>Max Boxes Per Person</label>
                                    <select class="form-control" id="maxBoxesPerPerson">
                                        <option value="5">5 Boxes</option>
                                        <option value="10" selected>10 Boxes</option>
                                        <option value="20">20 Boxes</option>
                                        <option value="0">Unlimited</option>
                                    </select>
                                </div>
                            </div>
                            <div class="info-box">
                                <div class="info-box-icon">üé≤</div>
                                <div class="info-box-content">
                                    <strong>Note</strong>
                                    <p>For advanced boxes management, use <a href="admin-boxes.html" style="color: var(--accent-blue);">Boxes Pools Admin</a> after creating.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="showSection('dashboard')">Cancel</button>
                        <button class="btn btn-gold" onclick="createPool()">Create Pool</button>
                    </div>
                </div>
            </section>

            <!-- All Pools Section -->
            <section class="content-section" id="pools">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">All Pools</h1>
                        <p class="page-subtitle">Manage all your pools</p>
                    </div>
                    <button class="btn btn-primary" onclick="showSection('create-pool')"><span>+</span> Create Pool</button>
                </div>

                <div class="data-card">
                    <div class="filter-bar">
                        <input type="text" class="form-control search-input" placeholder="Search pools..." id="poolSearchInput">
                        <select class="form-control" style="width: 150px;" id="poolStatusFilter">
                            <option value="">All Status</option>
                            <option value="open">Open</option>
                            <option value="live">Live</option>
                            <option value="closed">Closed</option>
                        </select>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr><th>Pool Name</th><th>Type</th><th>Entries</th><th>Prize Pool</th><th>Status</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="allPoolsTable">
                            <tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-muted);">Loading pools...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Entries Section -->
            <section class="content-section" id="entries">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Pool Entries</h1>
                        <p class="page-subtitle">View and manage all entries across pools</p>
                    </div>
                    <button class="btn btn-outline" onclick="exportEntries()">üì• Export CSV</button>
                </div>

                <div class="data-card">
                    <div class="filter-bar">
                        <input type="text" class="form-control search-input" placeholder="Search entries..." id="entrySearchInput">
                        <select class="form-control" style="width: 200px;" id="entryPoolFilter" onchange="loadEntries()">
                            <option value="">All Pools</option>
                        </select>
                    </div>
                    <table class="data-table" id="entriesTable">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="entryName" onclick="sortEntriesTable('entryName')">Entry Name <span class="sort-icon"></span></th>
                                <th>Pool</th>
                                <th class="sortable" data-sort="userName" onclick="sortEntriesTable('userName')">User <span class="sort-icon"></span></th>
                                <th class="sortable" data-sort="totalPoints" onclick="sortEntriesTable('totalPoints')">Points <span class="sort-icon"></span></th>
                                <th class="sortable" data-sort="paid" onclick="sortEntriesTable('paid')">Payment <span class="sort-icon"></span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="entriesTableBody">
                            <tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-muted);">Select a pool to view entries</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Payments Section -->
            <section class="content-section" id="payments">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Payment Tracking</h1>
                        <p class="page-subtitle">Track buy-in payments for all entries</p>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card green">
                        <div class="stat-label">Total Collected</div>
                        <div class="stat-value" id="paymentsCollected">$0</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-label">Outstanding</div>
                        <div class="stat-value" id="paymentsOutstanding">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Paid Entries</div>
                        <div class="stat-value" id="paymentsPaidCount">0</div>
                    </div>
                    <div class="stat-card gold">
                        <div class="stat-label">Unpaid Entries</div>
                        <div class="stat-value" id="paymentsUnpaidCount">0</div>
                    </div>
                </div>

                <div class="data-card">
                    <div class="data-card-header">
                        <h3 class="data-card-title">Unpaid Entries</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr><th>Entry Name</th><th>User</th><th>Pool</th><th>Amount Due</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="unpaidEntriesTable">
                            <tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-muted);">No unpaid entries</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Users Section -->
            <section class="content-section" id="users">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Manage Users</h1>
                        <p class="page-subtitle">View and manage user accounts and roles</p>
                    </div>
                </div>

                <div class="data-card">
                    <div class="filter-bar">
                        <input type="text" class="form-control search-input" placeholder="Search users..." id="userSearchInput">
                        <select class="form-control" style="width: 150px;" id="userRoleFilter">
                            <option value="">All Roles</option>
                            <option value="admin">Admin</option>
                            <option value="user">User</option>
                        </select>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr><th>User</th><th>Email</th><th>Role</th><th>Joined</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-muted);">Loading users...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Edit Pool Modal -->
    <div class="modal-overlay" id="editPoolModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Edit Pool</h3>
                <button class="modal-close" onclick="closeModal('editPoolModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editPoolId">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Pool Name</label>
                        <input type="text" class="form-control" id="editPoolName">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select class="form-control" id="editPoolStatus">
                            <option value="open">Open</option>
                            <option value="live">Live</option>
                            <option value="closed">Closed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Current Week</label>
                        <select class="form-control" id="editPoolCurrentWeek">
                            <option value="wildcard">Wild Card</option>
                            <option value="divisional">Divisional</option>
                            <option value="conference">Conference</option>
                            <option value="superbowl">Super Bowl</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Buy-In ($)</label>
                        <input type="number" class="form-control" id="editPoolBuyIn">
                    </div>
                    <div class="form-group">
                        <label>Entry Deadline</label>
                        <input type="datetime-local" class="form-control" id="editPoolDeadline">
                    </div>
                    <div class="form-group">
                        <div class="checkbox-label">
                            <input type="checkbox" id="editPoolShowStrength">
                            <span>Show Strength Rankings</span>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label>Description</label>
                        <textarea class="form-control" rows="3" id="editPoolDescription"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('editPoolModal')">Cancel</button>
                <button class="btn btn-gold" onclick="savePoolChanges()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    
    <script>
        let currentUser = null;
        let allPools = [];
        
        // Auth check - listen for custom event from firebase-config.js
        window.addEventListener('userLoggedIn', async (e) => {
            const { user, userData } = e.detail;
            console.log('Admin page: User logged in', user.email, 'Role:', userData?.role);
            
            if (!userData || userData.role !== 'admin') {
                alert('Access denied. Admin privileges required.');
                window.location.href = 'home.html';
                return;
            }
            
            currentUser = user;
            document.getElementById('adminName').textContent = userData.displayName || user.email;
            document.getElementById('adminAvatar').textContent = getUserInitials(userData.displayName || user.email);
            
            await loadDashboardData();
            await loadUsers();
        });
        
        window.addEventListener('userLoggedOut', () => {
            console.log('Admin page: User logged out, redirecting');
            window.location.href = 'home.html';
        });
        
        function handleLogout() {
            signOut().then(() => { window.location.href = 'home.html'; });
        }
        
        // Navigation
        document.querySelectorAll('.nav-item[data-section]').forEach(item => {
            item.addEventListener('click', () => {
                const section = item.dataset.section;
                if (section) showSection(section);
            });
        });
        
        function showSection(sectionId) {
            document.querySelectorAll('.nav-item[data-section]').forEach(item => {
                item.classList.toggle('active', item.dataset.section === sectionId);
            });
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.toggle('active', section.id === sectionId);
            });
            if (sectionId === 'entries') populatePoolFilter();
        }
        
        // Load dashboard data
        async function loadDashboardData() {
            try {
                const snapshot = await db.collection('pools').where('commissionerId', '==', currentUser.uid).get();
                
                allPools = [];
                let totalEntries = 0, totalPrize = 0;
                
                snapshot.forEach(doc => {
                    const pool = { id: doc.id, ...doc.data() };
                    allPools.push(pool);
                    totalEntries += pool.entryCount || 0;
                    totalPrize += (pool.buyIn || 0) * (pool.entryCount || 0);
                });
                
                document.getElementById('statActivePools').textContent = allPools.length;
                document.getElementById('statActivePoolsChange').textContent = `${allPools.filter(p => p.status === 'open').length} open`;
                document.getElementById('statTotalEntries').textContent = totalEntries;
                document.getElementById('statEntriesChange').textContent = 'Across all pools';
                document.getElementById('statPrizePool').textContent = `$${totalPrize.toLocaleString()}`;
                document.getElementById('statPrizeChange').textContent = 'Total prize money';
                document.getElementById('statPendingPayments').textContent = '0';
                document.getElementById('statPaymentsChange').textContent = 'Awaiting payment';
                
                updatePoolsTable(allPools, 'dashboardPoolsTable');
                updatePoolsTable(allPools, 'allPoolsTable');
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }
        
        function updatePoolsTable(pools, tableId) {
            const tbody = document.getElementById(tableId);
            if (!tbody) return;
            
            if (pools.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-muted);">No pools yet. Create your first pool!</td></tr>';
                return;
            }
            
            tbody.innerHTML = pools.map(pool => {
                const typeLabels = { 'betting-pool': 'üí∞ Betting', 'playoff-fantasy': 'üèà Fantasy', 'boxes-pool': 'üé≤ Boxes' };
                const typeLabel = typeLabels[pool.type] || pool.type;
                const status = pool.status || 'open';
                const prizePool = (pool.buyIn || 0) * (pool.entryCount || 0);
                const viewPage = pool.type === 'betting-pool' ? 'betting-pool.html' : 'pool.html';
                
                return `
                    <tr>
                        <td><strong>${pool.name}</strong></td>
                        <td>${typeLabel}</td>
                        <td>${pool.entryCount || 0}</td>
                        <td>$${prizePool.toLocaleString()}</td>
                        <td><span class="status-badge ${status}"><span class="dot"></span> ${status.charAt(0).toUpperCase() + status.slice(1)}</span></td>
                        <td>
                            <div class="action-btns">
                                <button class="action-btn" title="View" onclick="window.location.href='${viewPage}?id=${pool.id}'">üëÅ</button>
                                <button class="action-btn" title="Edit" onclick="editPool('${pool.id}')">‚úèÔ∏è</button>
                                <button class="action-btn" title="Share" onclick="copyPoolLink('${pool.id}')">üîó</button>
                                <button class="action-btn danger" title="Delete" onclick="deletePool('${pool.id}')">üóë</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Create pool
        async function createPool() {
            const name = document.getElementById('poolName').value;
            const poolType = document.getElementById('poolType').value;
            
            if (!name) { alert('Please enter a pool name'); return; }
            
            const btn = document.querySelector('#create-pool .btn-gold');
            btn.disabled = true;
            btn.textContent = 'Creating...';
            
            try {
                if (poolType === 'boxes-pool') {
                    await db.collection('boxesPools').add({
                        name, costPerBox: parseFloat(document.getElementById('costPerBox')?.value) || 10,
                        description: document.getElementById('poolDescription').value || '',
                        maxBoxesPerPerson: parseInt(document.getElementById('maxBoxesPerPerson')?.value) || 0,
                        paymentMethod: document.getElementById('paymentMethod').value || '',
                        games: [], entries: {}, locked: false,
                        createdBy: currentUser.uid,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert(`Boxes Pool "${name}" created!`);
                    if (confirm('Open Boxes Pools Admin now?')) window.location.href = 'admin-boxes.html';
                    else { document.getElementById('poolName').value = ''; showSection('dashboard'); }
                    return;
                }
                
                let poolData = {
                    name, type: poolType,
                    buyIn: parseFloat(document.getElementById('buyIn').value) || 0,
                    paymentMethod: document.getElementById('paymentMethod').value || '',
                    description: document.getElementById('poolDescription').value || '',
                    commissionerId: currentUser.uid,
                    commissionerName: currentUser.displayName || currentUser.email,
                    status: 'open', entryCount: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (poolType === 'playoff-fantasy') {
                    poolData.deadline = document.getElementById('deadline')?.value || null;
                    poolData.maxEntries = parseInt(document.getElementById('maxEntries')?.value) || 0;
                    poolData.allowLateEntries = document.getElementById('allowLateEntries')?.classList.contains('active') || false;
                    poolData.requirePayment = document.getElementById('requirePayment')?.classList.contains('active') || false;
                } else if (poolType === 'betting-pool') {
                    poolData.startingBankroll = parseFloat(document.getElementById('startingBankroll')?.value) || 1000;
                    poolData.minBet = parseFloat(document.getElementById('minBet')?.value) || 10;
                    poolData.maxBet = parseFloat(document.getElementById('maxBet')?.value) || 500;
                }
                
                await db.collection('pools').add(poolData);
                alert(`Pool "${name}" created successfully!`);
                document.getElementById('poolName').value = '';
                loadDashboardData();
                showSection('pools');
            } catch (error) {
                console.error('Error creating pool:', error);
                alert('Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Pool';
            }
        }
        
        function togglePoolTypeOptions() {
            const poolType = document.getElementById('poolType').value;
            document.getElementById('fantasyOptions').style.display = poolType === 'playoff-fantasy' ? 'block' : 'none';
            document.getElementById('bettingOptions').style.display = poolType === 'betting-pool' ? 'block' : 'none';
            document.getElementById('boxesOptions').style.display = poolType === 'boxes-pool' ? 'block' : 'none';
        }
        
        async function editPool(poolId) {
            const poolDoc = await db.collection('pools').doc(poolId).get();
            if (!poolDoc.exists) { alert('Pool not found'); return; }
            const pool = poolDoc.data();
            
            document.getElementById('editPoolId').value = poolId;
            document.getElementById('editPoolName').value = pool.name || '';
            document.getElementById('editPoolStatus').value = pool.status || 'open';
            document.getElementById('editPoolCurrentWeek').value = pool.currentWeek || 'wildcard';
            document.getElementById('editPoolBuyIn').value = pool.buyIn || 0;
            document.getElementById('editPoolDescription').value = pool.description || '';
            document.getElementById('editPoolShowStrength').checked = pool.showStrength || false;
            
            if (pool.deadline) {
                const d = pool.deadline.toDate ? pool.deadline.toDate() : new Date(pool.deadline);
                document.getElementById('editPoolDeadline').value = d.toISOString().slice(0, 16);
            }
            
            document.getElementById('editPoolModal').classList.add('active');
        }
        
        async function savePoolChanges() {
            const poolId = document.getElementById('editPoolId').value;
            const name = document.getElementById('editPoolName').value;
            if (!name) { alert('Pool name is required'); return; }
            
            try {
                const updateData = {
                    name, status: document.getElementById('editPoolStatus').value,
                    currentWeek: document.getElementById('editPoolCurrentWeek').value,
                    buyIn: parseFloat(document.getElementById('editPoolBuyIn').value) || 0,
                    description: document.getElementById('editPoolDescription').value,
                    showStrength: document.getElementById('editPoolShowStrength').checked,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                const deadlineStr = document.getElementById('editPoolDeadline').value;
                if (deadlineStr) updateData.deadline = new Date(deadlineStr);
                
                await db.collection('pools').doc(poolId).update(updateData);
                closeModal('editPoolModal');
                loadDashboardData();
                alert('Pool updated!');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function deletePool(poolId) {
            if (!confirm('Delete this pool? This cannot be undone.')) return;
            await db.collection('pools').doc(poolId).delete();
            loadDashboardData();
        }
        
        function copyPoolLink(poolId) {
            navigator.clipboard.writeText(`${window.location.origin}/pool.html?id=${poolId}`);
            alert('Pool link copied!');
        }
        
        // Users
        async function loadUsers() {
            const snapshot = await db.collection('users').orderBy('createdAt', 'desc').get();
            const tbody = document.getElementById('usersTableBody');
            
            if (snapshot.empty) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-muted);">No users found</td></tr>';
                return;
            }
            
            tbody.innerHTML = snapshot.docs.map(doc => {
                const user = doc.data();
                const joined = user.createdAt?.toDate?.().toLocaleDateString() || 'Unknown';
                return `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div class="user-avatar" style="width: 32px; height: 32px; font-size: 0.7rem;">${(user.displayName || user.email || '?').substring(0, 2).toUpperCase()}</div>
                                <span>${user.displayName || 'No name'}</span>
                            </div>
                        </td>
                        <td>${user.email || 'N/A'}</td>
                        <td style="${user.role === 'admin' ? 'color: var(--accent-gold);' : ''}">${user.role || 'user'}</td>
                        <td>${joined}</td>
                        <td><div class="action-btns"><button class="action-btn" title="View">üëÅ</button></div></td>
                    </tr>
                `;
            }).join('');
        }
        
        function populatePoolFilter() {
            const select = document.getElementById('entryPoolFilter');
            select.innerHTML = '<option value="">All Pools</option>' + allPools.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        }
        
        // Store entries data for sorting
        let currentEntriesData = [];
        let currentPoolId = null;
        let currentSortField = 'totalPoints';
        let currentSortDir = 'desc';
        
        // Helper to get user display name from entry - checks multiple possible fields
        function getUserFromEntry(entry) {
            return entry.userName || entry.userDisplayName || entry.displayName || 
                   entry.ownerName || entry.owner || entry.user || entry.userEmail || 
                   entry.email || entry.submittedBy || null;
        }
        
        async function loadEntries() {
            const poolId = document.getElementById('entryPoolFilter').value;
            const tbody = document.getElementById('entriesTableBody');
            
            if (!poolId) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-muted);">Select a pool to view entries</td></tr>';
                currentEntriesData = [];
                return;
            }
            
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-muted);">Loading entries...</td></tr>';
            
            try {
                // Get pool info
                const pool = allPools.find(p => p.id === poolId);
                currentPoolId = poolId;
                
                // Get entries from subcollection
                const snapshot = await db.collection('pools').doc(poolId)
                    .collection('entries')
                    .get();
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-muted);">No entries in this pool yet</td></tr>';
                    currentEntriesData = [];
                    return;
                }
                
                // Build entries array with resolved user names
                const entries = [];
                
                snapshot.docs.forEach(doc => {
                    const entry = doc.data();
                    const entryObj = {
                        id: doc.id,
                        entryName: entry.entryName || entry.teamName || '',
                        totalPoints: entry.totalPoints || 0,
                        paid: entry.paid || false,
                        userName: getUserFromEntry(entry),
                        userId: entry.userId || entry.uid || entry.ownerId || null,
                        poolName: pool?.name || 'Unknown Pool',
                        rawData: entry
                    };
                    entries.push(entryObj);
                });
                
                // Collect unique userIds that need lookup
                const userIdsNeedingLookup = [...new Set(
                    entries
                        .filter(e => !e.userName && e.userId)
                        .map(e => e.userId)
                )];
                
                // Lookup user names from users collection if needed
                if (userIdsNeedingLookup.length > 0) {
                    console.log('Looking up users:', userIdsNeedingLookup);
                    
                    const userMap = {};
                    for (const uid of userIdsNeedingLookup) {
                        try {
                            const userDoc = await db.collection('users').doc(uid).get();
                            if (userDoc.exists) {
                                const userData = userDoc.data();
                                userMap[uid] = userData.displayName || userData.name || userData.email || null;
                                console.log(`Found user ${uid}:`, userMap[uid]);
                            }
                        } catch (err) {
                            console.warn(`Failed to lookup user ${uid}:`, err);
                        }
                    }
                    
                    // Apply looked-up names
                    entries.forEach(entry => {
                        if (!entry.userName && entry.userId && userMap[entry.userId]) {
                            entry.userName = userMap[entry.userId];
                        }
                    });
                }
                
                // Set default for any still unknown
                entries.forEach((entry, idx) => {
                    if (!entry.userName) entry.userName = 'Unknown';
                    if (!entry.entryName) entry.entryName = 'Entry ' + (idx + 1);
                });
                
                currentEntriesData = entries;
                
                // Apply default sort and render
                sortEntriesTable('totalPoints', true);
                
            } catch (error) {
                console.error('Error loading entries:', error);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--accent-red);">Error loading entries: ' + error.message + '</td></tr>';
            }
        }
        
        function sortEntriesTable(field, skipToggle = false) {
            if (!currentEntriesData.length) return;
            
            // Toggle direction if same field, otherwise default to desc for points, asc for text
            if (!skipToggle) {
                if (currentSortField === field) {
                    currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSortDir = (field === 'totalPoints') ? 'desc' : 'asc';
                }
            }
            currentSortField = field;
            
            // Update header icons
            document.querySelectorAll('#entriesTable th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
                if (th.dataset.sort === field) {
                    th.classList.add(currentSortDir);
                }
            });
            
            // Sort data
            const sorted = [...currentEntriesData].sort((a, b) => {
                let valA = a[field];
                let valB = b[field];
                
                // Handle different types
                if (field === 'totalPoints') {
                    valA = Number(valA) || 0;
                    valB = Number(valB) || 0;
                } else if (field === 'paid') {
                    valA = valA ? 1 : 0;
                    valB = valB ? 1 : 0;
                } else {
                    valA = String(valA || '').toLowerCase();
                    valB = String(valB || '').toLowerCase();
                }
                
                if (valA < valB) return currentSortDir === 'asc' ? -1 : 1;
                if (valA > valB) return currentSortDir === 'asc' ? 1 : -1;
                return 0;
            });
            
            renderEntriesTable(sorted);
        }
        
        function renderEntriesTable(entries) {
            const tbody = document.getElementById('entriesTableBody');
            const pool = allPools.find(p => p.id === currentPoolId);
            
            // Build user count map to detect duplicates
            const userCounts = {};
            entries.forEach(entry => {
                const userKey = entry.userName.toLowerCase().trim();
                userCounts[userKey] = (userCounts[userKey] || 0) + 1;
            });
            
            tbody.innerHTML = entries.map((entry) => {
                const paidClass = entry.paid ? 'paid' : 'unpaid';
                const paidText = entry.paid ? 'Paid' : 'Unpaid';
                const userKey = entry.userName.toLowerCase().trim();
                const isDuplicate = userCounts[userKey] > 1;
                const duplicateCount = userCounts[userKey];
                
                return `
                    <tr${isDuplicate ? ' style="background: rgba(255, 193, 7, 0.1);"' : ''}>
                        <td><strong>${entry.entryName}</strong></td>
                        <td>${entry.poolName}</td>
                        <td>
                            ${entry.userName}
                            ${isDuplicate ? `<span style="margin-left: 0.5rem; padding: 2px 6px; background: var(--accent-gold); color: #000; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">${duplicateCount} entries</span>` : ''}
                        </td>
                        <td style="font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem;">${entry.totalPoints}</td>
                        <td><span class="status-badge ${paidClass}">${paidText}</span></td>
                        <td>
                            <div class="action-btns">
                                <button class="action-btn" title="View" onclick="viewEntry('${currentPoolId}', '${entry.id}')">üëÅ</button>
                                ${!entry.paid ? `<button class="action-btn" title="Mark Paid" onclick="markEntryPaid('${currentPoolId}', '${entry.id}', this)">üíµ</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function viewEntry(poolId, entryId) {
            // Could open a modal with entry details
            window.open(`pool.html?id=${poolId}#entry-${entryId}`, '_blank');
        }
        
        async function markEntryPaid(poolId, entryId, btn) {
            if (!confirm('Mark this entry as paid?')) return;
            
            try {
                await db.collection('pools').doc(poolId).collection('entries').doc(entryId).update({
                    paid: true,
                    paidAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update UI
                const row = btn.closest('tr');
                const badge = row.querySelector('.status-badge');
                badge.classList.remove('unpaid');
                badge.classList.add('paid');
                badge.textContent = 'Paid';
                btn.remove();
                
            } catch (error) {
                console.error('Error marking paid:', error);
                alert('Error: ' + error.message);
            }
        }
        function exportEntries() { alert('Exporting entries...'); }
        
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', e => { if (e.target === o) o.classList.remove('active'); }));
    </script>
</body>
</html>
