<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Manager | Gridiron Pools Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Roboto+Condensed:wght@300;400;700&family=Bebas+Neue&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-dark: #0a1628;
            --secondary-dark: #132238;
            --tertiary-dark: #1a2d47;
            --accent-blue: #00d4ff;
            --accent-gold: #ffc107;
            --accent-green: #00c853;
            --accent-red: #ff5252;
            --accent-orange: #ff9800;
            --text-primary: #ffffff;
            --text-secondary: #8ba3c7;
            --text-muted: #5a7194;
            --gradient-field: linear-gradient(135deg, #1a472a 0%, #2d5a3d 50%, #1a472a 100%);
            --card-bg: rgba(255,255,255,0.03);
            --card-border: rgba(255,255,255,0.08);
            --glow-blue: 0 0 40px rgba(0,212,255,0.3);
            --glow-gold: 0 0 30px rgba(255,193,7,0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto Condensed', sans-serif;
            background: var(--primary-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Layout */
        .admin-layout {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--secondary-dark);
            border-right: 1px solid var(--card-border);
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--card-border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient-field);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.1rem;
            color: white;
            border: 2px solid rgba(0,212,255,0.3);
        }

        .logo-text {
            font-family: 'Oswald', sans-serif;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .logo-text span {
            color: var(--accent-blue);
        }

        .sidebar-nav {
            flex: 1;
            padding: 1rem 0;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-section-title {
            padding: 0.5rem 1.5rem;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-item:hover {
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: rgba(0,212,255,0.1);
            color: var(--accent-blue);
            border-right: 3px solid var(--accent-blue);
        }

        .nav-item .icon {
            font-size: 1.1rem;
        }

        .sidebar-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--card-border);
        }

        .back-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: var(--accent-blue);
        }

        /* Main Content */
        main {
            flex: 1;
            margin-left: 260px;
            padding: 2rem;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
        }

        .page-title {
            font-family: 'Oswald', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Cards */
        .data-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .data-card-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--card-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .data-card-title {
            font-family: 'Oswald', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .data-card-body {
            padding: 1.5rem;
        }

        /* Buttons */
        .btn {
            font-family: 'Oswald', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 0.6rem 1.25rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: var(--primary-dark);
        }

        .btn-primary:hover {
            box-shadow: var(--glow-blue);
        }

        .btn-gold {
            background: var(--accent-gold);
            color: var(--primary-dark);
        }

        .btn-gold:hover {
            box-shadow: var(--glow-gold);
        }

        .btn-outline {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--card-border);
        }

        .btn-outline:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .btn-danger {
            background: var(--accent-red);
            color: white;
        }

        .btn-sm {
            padding: 0.4rem 0.75rem;
            font-size: 0.75rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--tertiary-dark);
            border: 1px solid var(--card-border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        textarea.form-control {
            min-height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .form-help {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .form-grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .form-grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        /* Import Section */
        .import-area {
            border: 2px dashed var(--card-border);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .import-area.drag-over {
            border-color: var(--accent-blue);
            background: rgba(0,212,255,0.05);
        }

        .csv-format {
            background: var(--tertiary-dark);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            overflow-x: auto;
            white-space: pre;
            color: var(--accent-green);
        }

        /* Preview Table */
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .preview-table th,
        .preview-table td {
            padding: 0.5rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--card-border);
        }

        .preview-table th {
            background: var(--tertiary-dark);
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.5px;
        }

        .preview-table tr:hover td {
            background: rgba(255,255,255,0.02);
        }

        .preview-scroll {
            max-height: 400px;
            overflow-y: auto;
        }

        /* Stats Summary */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-box {
            background: var(--tertiary-dark);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .stat-box-value {
            font-family: 'Oswald', sans-serif;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--accent-blue);
        }

        .stat-box-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Games List */
        .game-card {
            background: var(--tertiary-dark);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            gap: 1rem;
            align-items: center;
        }

        .game-round {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            padding: 0.25rem 0.5rem;
            background: var(--card-bg);
            border-radius: 4px;
        }

        .game-matchup {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .game-team {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .team-abbr {
            font-family: 'Oswald', sans-serif;
            font-size: 1.25rem;
            font-weight: 700;
            width: 50px;
        }

        .team-name {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .game-vs {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .game-lines {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
        }

        .game-line {
            text-align: center;
        }

        .game-line-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .game-line-value {
            font-family: 'Oswald', sans-serif;
            font-weight: 600;
        }

        .game-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .game-status.upcoming {
            background: rgba(0,212,255,0.2);
            color: var(--accent-blue);
        }

        .game-status.locked {
            background: rgba(255,152,0,0.2);
            color: var(--accent-orange);
        }

        .game-status.final {
            background: rgba(0,200,83,0.2);
            color: var(--accent-green);
        }

        /* Teams Grid */
        .teams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .team-card {
            background: var(--tertiary-dark);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.2s;
        }

        .team-card.eliminated {
            opacity: 0.5;
        }

        .team-logo {
            width: 50px;
            height: 50px;
            background: var(--card-bg);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Oswald', sans-serif;
            font-weight: 700;
            font-size: 1rem;
        }

        .team-info {
            flex: 1;
        }

        .team-card-name {
            font-family: 'Oswald', sans-serif;
            font-weight: 600;
        }

        .team-card-conf {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .team-toggle {
            width: 44px;
            height: 24px;
            background: var(--card-bg);
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }

        .team-toggle.active {
            background: var(--accent-green);
        }

        .team-toggle::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: transform 0.2s;
        }

        .team-toggle.active::after {
            transform: translateX(20px);
        }

        /* Alert */
        .alert {
            padding: 1rem 1.25rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .alert-success {
            background: rgba(0,200,83,0.1);
            border: 1px solid rgba(0,200,83,0.3);
            color: var(--accent-green);
        }

        .alert-error {
            background: rgba(255,82,82,0.1);
            border: 1px solid rgba(255,82,82,0.3);
            color: var(--accent-red);
        }

        .alert-info {
            background: rgba(0,212,255,0.1);
            border: 1px solid rgba(0,212,255,0.3);
            color: var(--accent-blue);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--card-border);
            padding-bottom: 0.5rem;
        }

        .tab {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-family: 'Oswald', sans-serif;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--text-primary);
            background: var(--card-bg);
        }

        .tab.active {
            color: var(--accent-blue);
            background: rgba(0,212,255,0.1);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--secondary-dark);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--card-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-family: 'Oswald', sans-serif;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--card-border);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--card-border);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 200px;
            }
            main {
                margin-left: 200px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            main {
                margin-left: 0;
            }
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <link rel="stylesheet" href="mobile-enhancements.css">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="home.html" class="logo">
                    <div class="logo-icon">GP</div>
                    <span class="logo-text">Data<span>Mgr</span></span>
                </a>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Season Setup</div>
                    <a class="nav-item active" data-section="setup-teams">
                        <span class="icon">‚öôÔ∏è</span>
                        Setup Teams
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Import Data</div>
                    <a class="nav-item" data-section="import-entries">
                        <span class="icon">üì•</span>
                        Import Entries
                    </a>
                    <a class="nav-item" data-section="import-players">
                        <span class="icon">üë•</span>
                        Import Players
                    </a>
                    <a class="nav-item" data-section="import-stats">
                        <span class="icon">üìä</span>
                        Import Stats
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Game Data</div>
                    <a class="nav-item" data-section="manage-games">
                        <span class="icon">üèà</span>
                        Manage Games
                    </a>
                    <a class="nav-item" data-section="teams-status">
                        <span class="icon">üèÜ</span>
                        Teams Status
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">View Data</div>
                    <a class="nav-item" data-section="view-players">
                        <span class="icon">üìã</span>
                        View Players
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <a href="admin.html" class="back-link">
                    ‚Üê Back to Admin Panel
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main>
            <!-- Setup Teams Section -->
            <section class="content-section active" id="setup-teams">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Setup Playoff Teams</h1>
                        <p class="page-subtitle">Add the 14 playoff teams for the current season</p>
                    </div>
                    <button class="btn btn-gold" onclick="showAddTeamModal()">+ Add Team</button>
                </div>

                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-box-value" id="setupTeamsCount">0</div>
                        <div class="stat-box-label">Teams Added</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-value" id="setupAFCCount">0</div>
                        <div class="stat-box-label">AFC Teams</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-value" id="setupNFCCount">0</div>
                        <div class="stat-box-label">NFC Teams</div>
                    </div>
                </div>

                <div class="data-card">
                    <div class="data-card-header">
                        <h3 class="data-card-title">Quick Setup - 2025 Playoff Teams</h3>
                    </div>
                    <div class="data-card-body">
                        <p style="margin-bottom: 1rem; color: var(--text-secondary);">Load all 14 playoff teams for the 2024-2025 NFL season:</p>
                        <button class="btn btn-primary" onclick="loadDefaultTeams2025()">Load 2025 Playoff Teams</button>
                        <button class="btn btn-outline" onclick="clearAllTeams()" style="margin-left: 0.5rem;">Clear All Teams</button>
                    </div>
                </div>

                <div class="data-card">
                    <div class="data-card-header">
                        <h3 class="data-card-title">AFC Teams</h3>
                    </div>
                    <div class="data-card-body">
                        <div class="teams-grid" id="setupAFCTeams">
                            <div class="loading">Loading teams...</div>
                        </div>
                    </div>
                </div>

                <div class="data-card">
                    <div class="data-card-header">
                        <h3 class="data-card-title">NFC Teams</h3>
                    </div>
                    <div class="data-card-body">
                        <div class="teams-grid" id="setupNFCTeams">
                            <div class="loading">Loading teams...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Import Entries Section -->
            <section class="content-section" id="import-entries">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Import Fantasy Entries</h1>
                        <p class="page-subtitle">Upload JSON file with fantasy team entries</p>
                    </div>
                </div>

                <div class="data-card">
                    <div class="data-card-header">
                        <h3 class="data-card-title">Select Pool</h3>
                    </div>
                    <div class="data-card-body">
                        <div class="form-group">
                            <label>Target Pool</label>
                            <select class="form-control" id="importPoolSelect" style="max-width: 400px;">
                                <option value="">Loading pools...</option>
                            </select>
                            <p class="form-help">Entries will be added to this fantasy pool</p>
                        </div>
                    </div>
                </div>

                <div class="data-card">
                    <div class="data-card-header">
                        <h3 class="data-card-title">JSON Format</h3>
                    </div>
                    <div class="data-card-body">
                        <p style="margin-bottom: 1rem; color: var(--text-secondary);">Expected JSON structure:</p>
                        <div class="csv-format">[
  {
    "teamName": "Owner Name",
    "tiebreaker": 45,
    "players": [
      { "position": "QB", "name": "Josh Allen" },
      { "position": "RB", "name": "Saquon Barkley" },
      ...
    ]
  }
]</div>
                    </div>
                </div>

                <div class="data-card">
                    <div class="data-card-header">
                        <h3 class="data-card-title">Upload JSON File</h3>
                    </div>
                    <div class="data-card-body">
                        <div class="form-group">
                            <input type="file" class="form-control" id="entriesJsonFile" accept=".json" onchange="previewEntries()">
                        </div>
                        <p style="color: var(--text-muted); font-size: 0.85rem;">Or paste JSON directly:</p>
                        <div class="form-group" style="margin-top: 0.5rem;">
                            <textarea class="form-control" id="entriesJsonText" placeholder="Paste JSON data here..." style="min-height: 150px;"></textarea>
                        </div>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <button class="btn btn-primary" onclick="previewEntriesFromText()">Preview Entries</button>
                            <span id="entriesPreviewCount" style="color: var(--text-muted);"></span>
                        </div>
                    </div>
                </div>

                <div class="data-card" id="entriesPreviewCard" style="display: none;">
                    <div class="data-card-header">
                        <h3 class="data-card-title">Preview Entries</h3>
                        <button class="btn btn-gold" onclick="importEntries()">‚úì Import All Entries</button>
                    </div>
                    <div class="data-card-body">
                        <div class="stats-grid" style="margin-bottom: 1rem;">
                            <div class="stat-box">
                                <div class="stat-box-value" id="previewEntryCount">0</div>
                                <div class="stat-box-label">Total Entries</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-box-value" id="previewPlayerCount">0</div>
                                <div class="stat-box-label">Total Players</div>
                            </div>
                        </div>
                        <div class="preview-scroll" style="max-height: 400px;">
                            <table class="preview-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Team Name</th>
                                        <th>Tiebreaker</th>
                                        <th>QB</th>
                                        <th>RB</th>
                                        <th>WR</th>
                                        <th>TE</th>
                                        <th>K</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="entriesPreviewBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="entriesImportResult"></div>
            </section>

            <!-- Import Players Section -->
            <section class="content-section" id="import-players">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Import Players</h1>
                        <p class="page-subtitle">Paste your player CSV to import the player database</p>
                    </div>
                </div>

                <div class="data-card">
                    <div class="data-card-header">
                        <h3 class="data-card-title">CSV Format</h3>
                    </div>
                    <div class="data-card-body">
                        <p style="margin-bottom: 1rem; color: var(--text-secondary);">Your CSV should have these columns (with header row):</p>
                        <div class="csv-format">name,team,position
Patrick Mahomes,KC,QB
Travis Kelce,KC,TE
Josh Allen,BUF,QB
Saquon Barkley,PHI,RB</div>
                        <p class="form-help" id="teamsHelpText">Teams: Loading...</p>
                        <p class="form-help">Positions: QB, RB, WR, TE, K</p>
                    </div>
                </div>

                <div class="data-card">
                    <div class="data-card-header">
                        <h3 class="data-card-title">Paste CSV</h3>
                    </div>
                    <div class="data-card-body">
                        <div class="form-group">
                            <textarea class="form-control" id="playersCsv" placeholder="Paste your CSV data here..."></textarea>
                        </div>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <button class="btn btn-primary" onclick="previewPlayers()">Preview Import</button>
                            <span id="playersPreviewCount" style="color: var(--text-muted);"></span>
                        </div>
                    </div>
                </div>

                <div class="data-card" id="playersPreviewCard" style="display: none;">
                    <div class="data-card-header">
                        <h3 class="data-card-title">Preview</h3>
                        <button class="btn btn-gold" onclick="importPlayers()">‚úì Import Players</button>
                    </div>
                    <div class="preview-scroll">
                        <table class="preview-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Team</th>
                                    <th>Position</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="playersPreviewBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="playersImportResult"></div>
            </section>

            <!-- Import Stats Section -->
            <section class="content-section" id="import-stats">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Import Stats</h1>
                        <p class="page-subtitle">Paste your master spreadsheet to update player stats</p>
                    </div>
                </div>

                <div class="data-card">
                    <div class="data-card-header">
                        <h3 class="data-card-title">CSV Format</h3>
                    </div>
                    <div class="data-card-body">
                        <p style="margin-bottom: 1rem; color: var(--text-secondary);">Your spreadsheet should have player info + stat columns per round:</p>
                        <div class="csv-format" style="font-size: 0.75rem;">name,team,position,WC_passYds,WC_passTD,WC_rushYds,WC_rushTD,WC_rec,WC_recYds,WC_recTD,WC_fg,WC_fg50,WC_xp,WC_2pt,DIV_passYds,...
Patrick Mahomes,KC,QB,289,2,34,0,0,0,0,0,0,0,0,312,3,...
Travis Kelce,KC,TE,0,0,0,0,8,84,1,0,0,0,0,0,0,...</div>
                        <p class="form-help" style="margin-top: 1rem;"><strong>Round prefixes:</strong> WC_ (Wild Card), DIV_ (Divisional), CONF_ (Conference), SB_ (Super Bowl)</p>
                        <p class="form-help"><strong>Stat columns:</strong> passYds, passTD, rushYds, rushTD, rec, recYds, recTD, fg, fg50, xp, 2pt</p>
                    </div>
                </div>

                <div class="data-card">
                    <div class="data-card-header">
                        <h3 class="data-card-title">Scoring Rules (Auto-calculated)</h3>
                    </div>
                    <div class="data-card-body">
                        <div class="form-grid-4">
                            <div class="stat-box">
                                <div class="stat-box-value">6</div>
                                <div class="stat-box-label">Per TD</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-box-value">1/25</div>
                                <div class="stat-box-label">Pass Yards</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-box-value">1/10</div>
                                <div class="stat-box-label">Rush/Rec Yds</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-box-value">1</div>
                                <div class="stat-box-label">Per Reception</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-box-value">3</div>
                                <div class="stat-box-label">FG (‚â§49)</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-box-value">5</div>
                                <div class="stat-box-label">FG (50+)</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-box-value">1</div>
                                <div class="stat-box-label">XP Made</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-box-value">2</div>
                                <div class="stat-box-label">2-Pt Conv</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="data-card">
                    <div class="data-card-header">
                        <h3 class="data-card-title">Upload JSON</h3>
                    </div>
                    <div class="data-card-body">
                        <p style="margin-bottom: 1rem; color: var(--text-secondary);">Or upload a JSON file with pre-calculated stats:</p>
                        <div class="form-group">
                            <input type="file" class="form-control" id="statsJsonFile" accept=".json" onchange="previewStatsJson()">
                        </div>
                        <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem;">Or paste JSON directly:</p>
                        <div class="form-group" style="margin-top: 0.5rem;">
                            <textarea class="form-control" id="statsJsonText" placeholder="Paste JSON data here..." style="min-height: 120px;"></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="previewStatsJsonFromText()">Preview JSON Stats</button>
                    </div>
                </div>

                <div class="data-card">
                    <div class="data-card-header">
                        <h3 class="data-card-title">Paste CSV</h3>
                    </div>
                    <div class="data-card-body">
                        <div class="form-group">
                            <textarea class="form-control" id="statsCsv" placeholder="Paste your master spreadsheet CSV here..."></textarea>
                        </div>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <button class="btn btn-primary" onclick="previewStats()">Preview & Calculate</button>
                            <span id="statsPreviewCount" style="color: var(--text-muted);"></span>
                        </div>
                    </div>
                </div>

                <div class="data-card" id="statsPreviewCard" style="display: none;">
                    <div class="data-card-header">
                        <h3 class="data-card-title">Preview - Calculated Points</h3>
                        <button class="btn btn-gold" onclick="importStats()">‚úì Import Stats</button>
                    </div>
                    <div class="preview-scroll">
                        <table class="preview-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Team</th>
                                    <th>Pos</th>
                                    <th>WC</th>
                                    <th>DIV</th>
                                    <th>CONF</th>
                                    <th>SB</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="statsPreviewBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="statsImportResult"></div>
            </section>

            <!-- Manage Games Section -->
            <section class="content-section" id="manage-games">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Manage Games</h1>
                        <p class="page-subtitle">Add and manage the 13 playoff games</p>
                    </div>
                    <button class="btn btn-primary" onclick="showAddGameModal()">
                        <span>‚ûï</span> Add Game
                    </button>
                </div>

                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-box-value" id="gamesCount">0</div>
                        <div class="stat-box-label">Total Games</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-value" id="gamesUpcoming">0</div>
                        <div class="stat-box-label">Upcoming</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-value" id="gamesLocked">0</div>
                        <div class="stat-box-label">Locked</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-value" id="gamesFinal">0</div>
                        <div class="stat-box-label">Final</div>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab active" data-round="all">All Games</button>
                    <button class="tab" data-round="wildcard">Wild Card</button>
                    <button class="tab" data-round="divisional">Divisional</button>
                    <button class="tab" data-round="conference">Conference</button>
                    <button class="tab" data-round="superbowl">Super Bowl</button>
                </div>

                <div id="gamesContainer">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Loading games...</p>
                    </div>
                </div>
            </section>

            <!-- Teams Status Section -->
            <section class="content-section" id="teams-status">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Teams Status</h1>
                        <p class="page-subtitle">Track which teams are still in the playoffs</p>
                    </div>
                    <button class="btn btn-outline" onclick="resetAllTeams()">Reset All Teams</button>
                </div>

                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-box-value" id="teamsActive">14</div>
                        <div class="stat-box-label">Active Teams</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-value" id="teamsEliminated">0</div>
                        <div class="stat-box-label">Eliminated</div>
                    </div>
                </div>

                <div class="data-card">
                    <div class="data-card-header">
                        <h3 class="data-card-title">AFC</h3>
                    </div>
                    <div class="data-card-body">
                        <div class="teams-grid" id="afcTeams"></div>
                    </div>
                </div>

                <div class="data-card">
                    <div class="data-card-header">
                        <h3 class="data-card-title">NFC</h3>
                    </div>
                    <div class="data-card-body">
                        <div class="teams-grid" id="nfcTeams"></div>
                    </div>
                </div>
            </section>

            <!-- View Players Section -->
            <section class="content-section" id="view-players">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">View Players</h1>
                        <p class="page-subtitle">View all imported players and their stats</p>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <select class="form-control" style="width: 140px;" id="viewPlayersTeam" onchange="loadPlayersView()">
                            <option value="all">All Teams</option>
                        </select>
                        <select class="form-control" style="width: 140px;" id="viewPlayersPos" onchange="loadPlayersView()">
                            <option value="all">All Positions</option>
                            <option value="QB">QB</option>
                            <option value="RB">RB</option>
                            <option value="WR">WR</option>
                            <option value="TE">TE</option>
                            <option value="K">K</option>
                        </select>
                        <button class="btn btn-primary" onclick="recalculateAllPoints()">üîÑ Recalculate All Points</button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-box-value" id="playersCount">0</div>
                        <div class="stat-box-label">Total Players</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-value" id="playersQB">0</div>
                        <div class="stat-box-label">QBs</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-value" id="playersRB">0</div>
                        <div class="stat-box-label">RBs</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-value" id="playersWR">0</div>
                        <div class="stat-box-label">WRs</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-value" id="playersTE">0</div>
                        <div class="stat-box-label">TEs</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-value" id="playersK">0</div>
                        <div class="stat-box-label">Ks</div>
                    </div>
                </div>

                <div class="data-card">
                    <div class="preview-scroll">
                        <table class="preview-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Team</th>
                                    <th>Pos</th>
                                    <th>Status</th>
                                    <th>WC</th>
                                    <th>DIV</th>
                                    <th>CONF</th>
                                    <th>SB</th>
                                    <th>Total</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="playersViewBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Edit Player Modal -->
    <div class="modal-overlay" id="editPlayerModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">Edit Player</h3>
                <button class="modal-close" onclick="closeModal('editPlayerModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editPlayerId">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" class="form-control" id="editPlayerName">
                    </div>
                    <div class="form-group">
                        <label>Team</label>
                        <select class="form-control" id="editPlayerTeam"></select>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Position</label>
                        <select class="form-control" id="editPlayerPosition" onchange="toggleStatsFields()">
                            <option value="QB">QB</option>
                            <option value="RB">RB</option>
                            <option value="WR">WR</option>
                            <option value="TE">TE</option>
                            <option value="K">K</option>
                        </select>
                    </div>
                    <div class="form-group" style="display: flex; align-items: center; padding-top: 1.5rem;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="editPlayerIR" style="margin-right: 0.5rem; width: 18px; height: 18px;">
                            <span style="color: var(--accent-red); font-weight: 600;">IR / Out</span>
                        </label>
                    </div>
                </div>
                
                <!-- Stats Section -->
                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--card-border);">
                    <h4 style="margin-bottom: 1rem; color: var(--accent-gold);">Player Stats</h4>
                    
                    <!-- Skill Position Stats -->
                    <div id="skillStatsFields">
                        <table class="preview-table" style="font-size: 0.85rem;">
                            <thead>
                                <tr>
                                    <th>Round</th>
                                    <th>Pass Yds</th>
                                    <th>Rush Yds</th>
                                    <th>Rec Yds</th>
                                    <th>Rec</th>
                                    <th>TD</th>
                                    <th>2PT</th>
                                    <th>Pts</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>WC</strong></td>
                                    <td><input type="number" class="form-control" id="editStats_WC_passYds" style="width: 70px; padding: 0.25rem;"></td>
                                    <td><input type="number" class="form-control" id="editStats_WC_rushYds" style="width: 70px; padding: 0.25rem;"></td>
                                    <td><input type="number" class="form-control" id="editStats_WC_recYds" style="width: 70px; padding: 0.25rem;"></td>
                                    <td><input type="number" class="form-control" id="editStats_WC_rec" style="width: 50px; padding: 0.25rem;"></td>
                                    <td><input type="number" class="form-control" id="editStats_WC_td" style="width: 50px; padding: 0.25rem;"></td>
                                    <td><input type="number" class="form-control" id="editStats_WC_2pt" style="width: 50px; padding: 0.25rem;"></td>
                                    <td><span id="editStats_WC_pts" style="font-weight: 600; color: var(--accent-gold);">0</span></td>
                                </tr>
                                <tr>
                                    <td><strong>DIV</strong></td>
                                    <td><input type="number" class="form-control" id="editStats_DIV_passYds" style="width: 70px; padding: 0.25rem;"></td>
                                    <td><input type="number" class="form-control" id="editStats_DIV_rushYds" style="width: 70px; padding: 0.25rem;"></td>
                                    <td><input type="number" class="form-control" id="editStats_DIV_recYds" style="width: 70px; padding: 0.25rem;"></td>
                                    <td><input type="number" class="form-control" id="editStats_DIV_rec" style="width: 50px; padding: 0.25rem;"></td>
                                    <td><input type="number" class="form-control" id="editStats_DIV_td" style="width: 50px; padding: 0.25rem;"></td>
                                    <td><input type="number" class="form-control" id="editStats_DIV_2pt" style="width: 50px; padding: 0.25rem;"></td>
                                    <td><span id="editStats_DIV_pts" style="font-weight: 600; color: var(--accent-gold);">0</span></td>
                                </tr>
                                <tr>
                                    <td><strong>CONF</strong></td>
                                    <td><input type="number" class="form-control" id="editStats_CONF_passYds" style="width: 70px; padding: 0.25rem;"></td>
                                    <td><input type="number" class="form-control" id="editStats_CONF_rushYds" style="width: 70px; padding: 0.25rem;"></td>
                                    <td><input type="number" class="form-control" id="editStats_CONF_recYds" style="width: 70px; padding: 0.25rem;"></td>
                                    <td><input type="number" class="form-control" id="editStats_CONF_rec" style="width: 50px; padding: 0.25rem;"></td>
                                    <td><input type="number" class="form-control" id="editStats_CONF_td" style="width: 50px; padding: 0.25rem;"></td>
                                    <td><input type="number" class="form-control" id="editStats_CONF_2pt" style="width: 50px; padding: 0.25rem;"></td>
                                    <td><span id="editStats_CONF_pts" style="font-weight: 600; color: var(--accent-gold);">0</span></td>
                                </tr>
                                <tr>
                                    <td><strong>SB</strong></td>
                                    <td><input type="number" class="form-control" id="editStats_SB_passYds" style="width: 70px; padding: 0.25rem;"></td>
                                    <td><input type="number" class="form-control" id="editStats_SB_rushYds" style="width: 70px; padding: 0.25rem;"></td>
                                    <td><input type="number" class="form-control" id="editStats_SB_recYds" style="width: 70px; padding: 0.25rem;"></td>
                                    <td><input type="number" class="form-control" id="editStats_SB_rec" style="width: 50px; padding: 0.25rem;"></td>
                                    <td><input type="number" class="form-control" id="editStats_SB_td" style="width: 50px; padding: 0.25rem;"></td>
                                    <td><input type="number" class="form-control" id="editStats_SB_2pt" style="width: 50px; padding: 0.25rem;"></td>
                                    <td><span id="editStats_SB_pts" style="font-weight: 600; color: var(--accent-gold);">0</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Kicker Stats -->
                    <div id="kickerStatsFields" style="display: none;">
                        <table class="preview-table" style="font-size: 0.85rem;">
                            <thead>
                                <tr>
                                    <th>Round</th>
                                    <th>PAT</th>
                                    <th>FG (&lt;50)</th>
                                    <th>FG (50+)</th>
                                    <th>Pts</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>WC</strong></td>
                                    <td><input type="number" class="form-control" id="editStats_WC_xp" style="width: 60px; padding: 0.25rem;"></td>
                                    <td><input type="number" class="form-control" id="editStats_WC_fg" style="width: 60px; padding: 0.25rem;"></td>
                                    <td><input type="number" class="form-control" id="editStats_WC_fg50" style="width: 60px; padding: 0.25rem;"></td>
                                    <td><span id="editStats_WC_kpts" style="font-weight: 600; color: var(--accent-gold);">0</span></td>
                                </tr>
                                <tr>
                                    <td><strong>DIV</strong></td>
                                    <td><input type="number" class="form-control" id="editStats_DIV_xp" style="width: 60px; padding: 0.25rem;"></td>
                                    <td><input type="number" class="form-control" id="editStats_DIV_fg" style="width: 60px; padding: 0.25rem;"></td>
                                    <td><input type="number" class="form-control" id="editStats_DIV_fg50" style="width: 60px; padding: 0.25rem;"></td>
                                    <td><span id="editStats_DIV_kpts" style="font-weight: 600; color: var(--accent-gold);">0</span></td>
                                </tr>
                                <tr>
                                    <td><strong>CONF</strong></td>
                                    <td><input type="number" class="form-control" id="editStats_CONF_xp" style="width: 60px; padding: 0.25rem;"></td>
                                    <td><input type="number" class="form-control" id="editStats_CONF_fg" style="width: 60px; padding: 0.25rem;"></td>
                                    <td><input type="number" class="form-control" id="editStats_CONF_fg50" style="width: 60px; padding: 0.25rem;"></td>
                                    <td><span id="editStats_CONF_kpts" style="font-weight: 600; color: var(--accent-gold);">0</span></td>
                                </tr>
                                <tr>
                                    <td><strong>SB</strong></td>
                                    <td><input type="number" class="form-control" id="editStats_SB_xp" style="width: 60px; padding: 0.25rem;"></td>
                                    <td><input type="number" class="form-control" id="editStats_SB_fg" style="width: 60px; padding: 0.25rem;"></td>
                                    <td><input type="number" class="form-control" id="editStats_SB_fg50" style="width: 60px; padding: 0.25rem;"></td>
                                    <td><span id="editStats_SB_kpts" style="font-weight: 600; color: var(--accent-gold);">0</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 1rem; text-align: right;">
                        <span style="color: var(--text-muted); margin-right: 1rem;">Total: <strong id="editStatsTotalPts" style="color: var(--accent-blue); font-size: 1.1rem;">0</strong></span>
                        <button class="btn btn-outline btn-sm" onclick="recalculateEditStats()">Recalculate Points</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger btn-sm" onclick="deletePlayerFromEdit()" style="margin-right: auto;">Delete</button>
                <button class="btn btn-outline" onclick="closeModal('editPlayerModal')">Cancel</button>
                <button class="btn btn-gold" onclick="updatePlayer()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Add Game Modal -->
    <div class="modal-overlay" id="addGameModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add New Game</h3>
                <button class="modal-close" onclick="closeModal('addGameModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Round</label>
                        <select class="form-control" id="newGameRound">
                            <option value="wildcard">Wild Card</option>
                            <option value="divisional">Divisional</option>
                            <option value="conference">Conference</option>
                            <option value="superbowl">Super Bowl</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Game Date & Time</label>
                        <input type="datetime-local" class="form-control" id="newGameDateTime">
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Away Team</label>
                        <select class="form-control" id="newGameAway">
                            <option value="">Select team...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Home Team</label>
                        <select class="form-control" id="newGameHome">
                            <option value="">Select team...</option>
                        </select>
                    </div>
                </div>
                <hr style="border-color: var(--card-border); margin: 1.5rem 0;">
                <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1rem;">Betting Lines (optional)</p>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Away Spread</label>
                        <input type="text" class="form-control" id="newGameAwaySpread" placeholder="+2.5">
                    </div>
                    <div class="form-group">
                        <label>Home Spread</label>
                        <input type="text" class="form-control" id="newGameHomeSpread" placeholder="-2.5">
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Away Moneyline</label>
                        <input type="text" class="form-control" id="newGameAwayML" placeholder="+120">
                    </div>
                    <div class="form-group">
                        <label>Home Moneyline</label>
                        <input type="text" class="form-control" id="newGameHomeML" placeholder="-140">
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Over/Under Total</label>
                        <input type="text" class="form-control" id="newGameTotal" placeholder="45.5">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select class="form-control" id="newGameStatus">
                            <option value="upcoming">Upcoming</option>
                            <option value="locked">Locked</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('addGameModal')">Cancel</button>
                <button class="btn btn-gold" onclick="saveGame()">Save Game</button>
            </div>
        </div>
    </div>

    <!-- Edit Game Modal -->
    <div class="modal-overlay" id="editGameModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Edit Game</h3>
                <button class="modal-close" onclick="closeModal('editGameModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editGameId">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Round</label>
                        <select class="form-control" id="editGameRound">
                            <option value="wildcard">Wild Card</option>
                            <option value="divisional">Divisional</option>
                            <option value="conference">Conference</option>
                            <option value="superbowl">Super Bowl</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Game Date & Time</label>
                        <input type="datetime-local" class="form-control" id="editGameDateTime">
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Away Team</label>
                        <select class="form-control" id="editGameAway"></select>
                    </div>
                    <div class="form-group">
                        <label>Home Team</label>
                        <select class="form-control" id="editGameHome"></select>
                    </div>
                </div>
                <hr style="border-color: var(--card-border); margin: 1.5rem 0;">
                <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1rem;">Betting Lines</p>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Away Spread</label>
                        <input type="text" class="form-control" id="editGameAwaySpread">
                    </div>
                    <div class="form-group">
                        <label>Home Spread</label>
                        <input type="text" class="form-control" id="editGameHomeSpread">
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Away Moneyline</label>
                        <input type="text" class="form-control" id="editGameAwayML">
                    </div>
                    <div class="form-group">
                        <label>Home Moneyline</label>
                        <input type="text" class="form-control" id="editGameHomeML">
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Over/Under Total</label>
                        <input type="text" class="form-control" id="editGameTotal">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select class="form-control" id="editGameStatus">
                            <option value="upcoming">Upcoming</option>
                            <option value="locked">Locked</option>
                            <option value="final">Final</option>
                        </select>
                    </div>
                </div>
                <hr style="border-color: var(--card-border); margin: 1.5rem 0;">
                <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1rem;">Final Score (if settled)</p>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Away Score</label>
                        <input type="number" class="form-control" id="editGameAwayScore" placeholder="--">
                    </div>
                    <div class="form-group">
                        <label>Home Score</label>
                        <input type="number" class="form-control" id="editGameHomeScore" placeholder="--">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger btn-sm" onclick="deleteGame()" style="margin-right: auto;">Delete</button>
                <button class="btn btn-outline" onclick="closeModal('editGameModal')">Cancel</button>
                <button class="btn btn-gold" onclick="updateGame()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Add Team Modal -->
    <div class="modal-overlay" id="addTeamModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add Playoff Team</h3>
                <button class="modal-close" onclick="closeModal('addTeamModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Team Abbreviation</label>
                        <input type="text" class="form-control" id="newTeamAbbr" placeholder="KC" maxlength="4" style="text-transform: uppercase;">
                        <p class="form-help">2-4 letter code (e.g., KC, BUF, LAC)</p>
                    </div>
                    <div class="form-group">
                        <label>Team Name</label>
                        <input type="text" class="form-control" id="newTeamName" placeholder="Chiefs">
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" class="form-control" id="newTeamFullName" placeholder="Kansas City Chiefs">
                    </div>
                    <div class="form-group">
                        <label>Conference</label>
                        <select class="form-control" id="newTeamConference">
                            <option value="AFC">AFC</option>
                            <option value="NFC">NFC</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Seed (1-7)</label>
                    <select class="form-control" id="newTeamSeed" style="width: 100px;">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('addTeamModal')">Cancel</button>
                <button class="btn btn-gold" onclick="saveTeam()">Add Team</button>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>

    <script>
        // =========================================
        // TEAMS DATA (Loaded from Firestore)
        // =========================================
        let TEAMS = {};

        const ROUNDS = {
            wildcard: 'Wild Card',
            divisional: 'Divisional',
            conference: 'Conference',
            superbowl: 'Super Bowl'
        };

        // Default teams for 2025 playoffs (can be loaded with one click)
        const DEFAULT_TEAMS_2025 = {
            KC: { name: 'Chiefs', fullName: 'Kansas City Chiefs', conference: 'AFC', seed: 1 },
            BUF: { name: 'Bills', fullName: 'Buffalo Bills', conference: 'AFC', seed: 2 },
            BAL: { name: 'Ravens', fullName: 'Baltimore Ravens', conference: 'AFC', seed: 3 },
            HOU: { name: 'Texans', fullName: 'Houston Texans', conference: 'AFC', seed: 4 },
            LAC: { name: 'Chargers', fullName: 'Los Angeles Chargers', conference: 'AFC', seed: 5 },
            PIT: { name: 'Steelers', fullName: 'Pittsburgh Steelers', conference: 'AFC', seed: 6 },
            DEN: { name: 'Broncos', fullName: 'Denver Broncos', conference: 'AFC', seed: 7 },
            DET: { name: 'Lions', fullName: 'Detroit Lions', conference: 'NFC', seed: 1 },
            PHI: { name: 'Eagles', fullName: 'Philadelphia Eagles', conference: 'NFC', seed: 2 },
            TB: { name: 'Buccaneers', fullName: 'Tampa Bay Buccaneers', conference: 'NFC', seed: 3 },
            LAR: { name: 'Rams', fullName: 'Los Angeles Rams', conference: 'NFC', seed: 4 },
            MIN: { name: 'Vikings', fullName: 'Minnesota Vikings', conference: 'NFC', seed: 5 },
            WAS: { name: 'Commanders', fullName: 'Washington Commanders', conference: 'NFC', seed: 6 },
            GB: { name: 'Packers', fullName: 'Green Bay Packers', conference: 'NFC', seed: 7 }
        };

        // =========================================
        // LOAD PLAYOFF TEAMS FROM FIRESTORE
        // =========================================
        async function loadPlayoffTeams() {
            try {
                const snapshot = await db.collection('teams').get();
                TEAMS = {};
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    TEAMS[doc.id] = {
                        name: data.name,
                        fullName: data.fullName,
                        conference: data.conference,
                        seed: data.seed,
                        eliminated: data.eliminated || false
                    };
                });

                // Update UI elements
                updateTeamsHelpText();
                renderSetupTeams();
                populateTeamSelects();
                
                console.log(`Loaded ${Object.keys(TEAMS).length} teams from Firestore`);
                return TEAMS;
            } catch (error) {
                console.error('Error loading teams:', error);
                return {};
            }
        }

        function updateTeamsHelpText() {
            const helpText = document.getElementById('teamsHelpText');
            if (helpText) {
                const teamList = Object.keys(TEAMS).sort().join(', ');
                helpText.textContent = teamList ? `Teams: ${teamList}` : 'Teams: No teams loaded. Go to Setup Teams first.';
            }
        }

        function renderSetupTeams() {
            const afcContainer = document.getElementById('setupAFCTeams');
            const nfcContainer = document.getElementById('setupNFCTeams');
            
            if (!afcContainer || !nfcContainer) return;

            const afcTeams = Object.entries(TEAMS)
                .filter(([_, t]) => t.conference === 'AFC')
                .sort((a, b) => a[1].seed - b[1].seed);
            const nfcTeams = Object.entries(TEAMS)
                .filter(([_, t]) => t.conference === 'NFC')
                .sort((a, b) => a[1].seed - b[1].seed);

            // Update counts
            document.getElementById('setupTeamsCount').textContent = Object.keys(TEAMS).length;
            document.getElementById('setupAFCCount').textContent = afcTeams.length;
            document.getElementById('setupNFCCount').textContent = nfcTeams.length;

            if (afcTeams.length === 0) {
                afcContainer.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No AFC teams added yet</p>';
            } else {
                afcContainer.innerHTML = afcTeams.map(([abbr, team]) => renderSetupTeamCard(abbr, team)).join('');
            }

            if (nfcTeams.length === 0) {
                nfcContainer.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No NFC teams added yet</p>';
            } else {
                nfcContainer.innerHTML = nfcTeams.map(([abbr, team]) => renderSetupTeamCard(abbr, team)).join('');
            }
        }

        function renderSetupTeamCard(abbr, team) {
            return `
                <div class="team-card">
                    <div class="team-logo">${abbr}</div>
                    <div class="team-info">
                        <div class="team-card-name">${team.fullName}</div>
                        <div class="team-card-conf">${team.conference} #${team.seed}</div>
                    </div>
                    <button class="btn btn-outline btn-sm" onclick="deleteTeam('${abbr}')" title="Remove team">üóëÔ∏è</button>
                </div>
            `;
        }

        function showAddTeamModal() {
            document.getElementById('newTeamAbbr').value = '';
            document.getElementById('newTeamName').value = '';
            document.getElementById('newTeamFullName').value = '';
            document.getElementById('newTeamConference').value = 'AFC';
            document.getElementById('newTeamSeed').value = '1';
            document.getElementById('addTeamModal').classList.add('active');
        }

        async function saveTeam() {
            const abbr = document.getElementById('newTeamAbbr').value.trim().toUpperCase();
            const name = document.getElementById('newTeamName').value.trim();
            const fullName = document.getElementById('newTeamFullName').value.trim();
            const conference = document.getElementById('newTeamConference').value;
            const seed = parseInt(document.getElementById('newTeamSeed').value);

            if (!abbr || !name || !fullName) {
                alert('Please fill in all fields');
                return;
            }

            if (TEAMS[abbr]) {
                alert(`Team ${abbr} already exists`);
                return;
            }

            try {
                await db.collection('teams').doc(abbr).set({
                    name,
                    fullName,
                    conference,
                    seed,
                    eliminated: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                closeModal('addTeamModal');
                await loadPlayoffTeams();
            } catch (error) {
                console.error('Error adding team:', error);
                alert('Error adding team: ' + error.message);
            }
        }

        async function deleteTeam(abbr) {
            if (!confirm(`Remove ${abbr} from playoff teams? This won't delete associated players.`)) return;

            try {
                await db.collection('teams').doc(abbr).delete();
                await loadPlayoffTeams();
            } catch (error) {
                console.error('Error deleting team:', error);
                alert('Error deleting team: ' + error.message);
            }
        }

        async function clearAllTeams() {
            if (!confirm('Remove ALL playoff teams? This will clear the teams list but not delete players.')) return;

            try {
                const snapshot = await db.collection('teams').get();
                const batch = db.batch();
                snapshot.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                await loadPlayoffTeams();
            } catch (error) {
                console.error('Error clearing teams:', error);
                alert('Error clearing teams: ' + error.message);
            }
        }

        async function loadDefaultTeams2025() {
            if (Object.keys(TEAMS).length > 0) {
                if (!confirm('This will replace existing teams with the 2025 playoff teams. Continue?')) return;
                await clearAllTeams();
            }

            try {
                const batch = db.batch();
                for (const [abbr, team] of Object.entries(DEFAULT_TEAMS_2025)) {
                    const ref = db.collection('teams').doc(abbr);
                    batch.set(ref, {
                        ...team,
                        eliminated: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                await batch.commit();
                await loadPlayoffTeams();
                alert('Successfully loaded 14 playoff teams for 2025!');
            } catch (error) {
                console.error('Error loading default teams:', error);
                alert('Error loading teams: ' + error.message);
            }
        }

        // =========================================
        // IMPORT FANTASY ENTRIES
        // =========================================
        let entriesToImport = [];

        async function loadPoolsForImport() {
            const select = document.getElementById('importPoolSelect');
            if (!select) return;

            try {
                const snapshot = await db.collection('pools')
                    .where('type', '==', 'playoff-fantasy')
                    .get();
                
                select.innerHTML = '<option value="">Select a pool...</option>';
                
                if (snapshot.empty) {
                    select.innerHTML += '<option value="" disabled>No fantasy pools found</option>';
                    return;
                }

                snapshot.docs.forEach(doc => {
                    const pool = doc.data();
                    select.innerHTML += `<option value="${doc.id}">${pool.name || doc.id}</option>`;
                });
            } catch (error) {
                console.error('Error loading pools:', error);
                select.innerHTML = '<option value="">Error loading pools</option>';
            }
        }

        function previewEntries() {
            const fileInput = document.getElementById('entriesJsonFile');
            if (!fileInput.files || !fileInput.files[0]) {
                alert('Please select a JSON file');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    processEntriesPreview(data);
                } catch (error) {
                    alert('Invalid JSON file: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        }

        function previewEntriesFromText() {
            const text = document.getElementById('entriesJsonText').value.trim();
            if (!text) {
                alert('Please paste JSON data or upload a file');
                return;
            }

            try {
                const data = JSON.parse(text);
                processEntriesPreview(data);
            } catch (error) {
                alert('Invalid JSON: ' + error.message);
            }
        }

        function processEntriesPreview(data) {
            if (!Array.isArray(data)) {
                alert('JSON must be an array of entries');
                return;
            }

            entriesToImport = data;
            const tbody = document.getElementById('entriesPreviewBody');
            tbody.innerHTML = '';

            let totalPlayers = 0;

            data.forEach((entry, index) => {
                const players = entry.players || [];
                totalPlayers += players.length;

                // Count by position
                const qbCount = players.filter(p => p.position === 'QB').length;
                const rbCount = players.filter(p => p.position === 'RB').length;
                const wrCount = players.filter(p => p.position === 'WR').length;
                const teCount = players.filter(p => p.position === 'TE').length;
                const kCount = players.filter(p => p.position === 'K').length;

                // Validate entry
                const isValid = entry.teamName && players.length === 14 && 
                    qbCount === 2 && rbCount === 4 && wrCount === 4 && teCount === 2 && kCount === 2;

                tbody.innerHTML += `
                    <tr style="${!isValid ? 'color: var(--accent-orange);' : ''}">
                        <td>${index + 1}</td>
                        <td>${entry.teamName || 'No name'}</td>
                        <td>${entry.tiebreaker || '-'}</td>
                        <td>${qbCount}</td>
                        <td>${rbCount}</td>
                        <td>${wrCount}</td>
                        <td>${teCount}</td>
                        <td>${kCount}</td>
                        <td>${isValid ? '‚úì' : '‚ö†Ô∏è'}</td>
                    </tr>
                `;
            });

            document.getElementById('previewEntryCount').textContent = data.length;
            document.getElementById('previewPlayerCount').textContent = totalPlayers;
            document.getElementById('entriesPreviewCard').style.display = 'block';
            document.getElementById('entriesPreviewCount').textContent = `${data.length} entries found`;
        }

        async function importEntries() {
            const poolId = document.getElementById('importPoolSelect').value;
            if (!poolId) {
                alert('Please select a target pool first');
                return;
            }

            if (entriesToImport.length === 0) {
                alert('No entries to import');
                return;
            }

            if (!confirm(`Import ${entriesToImport.length} entries to the selected pool?`)) {
                return;
            }

            const resultDiv = document.getElementById('entriesImportResult');
            resultDiv.innerHTML = '<div class="alert alert-info">Importing entries... Please wait.</div>';

            try {
                let imported = 0;
                let errors = 0;

                for (const entry of entriesToImport) {
                    try {
                        // Format players by position for the entry structure
                        const players = entry.players || [];
                        const roster = {
                            qb1: players.find(p => p.position === 'QB')?.name || '',
                            qb2: players.filter(p => p.position === 'QB')[1]?.name || '',
                            rb1: players.find(p => p.position === 'RB')?.name || '',
                            rb2: players.filter(p => p.position === 'RB')[1]?.name || '',
                            rb3: players.filter(p => p.position === 'RB')[2]?.name || '',
                            rb4: players.filter(p => p.position === 'RB')[3]?.name || '',
                            wr1: players.find(p => p.position === 'WR')?.name || '',
                            wr2: players.filter(p => p.position === 'WR')[1]?.name || '',
                            wr3: players.filter(p => p.position === 'WR')[2]?.name || '',
                            wr4: players.filter(p => p.position === 'WR')[3]?.name || '',
                            te1: players.find(p => p.position === 'TE')?.name || '',
                            te2: players.filter(p => p.position === 'TE')[1]?.name || '',
                            k1: players.find(p => p.position === 'K')?.name || '',
                            k2: players.filter(p => p.position === 'K')[1]?.name || ''
                        };

                        await db.collection('pools').doc(poolId).collection('entries').add({
                            teamName: entry.teamName,
                            tiebreaker: entry.tiebreaker || 0,
                            players: entry.players,
                            roster: roster,
                            totalPoints: 0,
                            weekPoints: {
                                wildCard: 0,
                                divisional: 0,
                                conference: 0,
                                superBowl: 0
                            },
                            paid: false,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        imported++;
                    } catch (err) {
                        console.error('Error importing entry:', entry.teamName, err);
                        errors++;
                    }
                }

                // Update pool entry count
                await db.collection('pools').doc(poolId).update({
                    entryCount: firebase.firestore.FieldValue.increment(imported)
                });

                if (errors === 0) {
                    resultDiv.innerHTML = `<div class="alert alert-success">‚úì Successfully imported ${imported} entries!</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-warning">Imported ${imported} entries with ${errors} errors.</div>`;
                }

                // Clear preview
                entriesToImport = [];
                document.getElementById('entriesPreviewCard').style.display = 'none';
                document.getElementById('entriesJsonFile').value = '';
                document.getElementById('entriesJsonText').value = '';
                document.getElementById('entriesPreviewCount').textContent = '';

            } catch (error) {
                console.error('Import error:', error);
                resultDiv.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
            }
        }

        // =========================================
        // NAVIGATION
        // =========================================
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const section = item.dataset.section;
                if (section) {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                    item.classList.add('active');
                    document.getElementById(section).classList.add('active');
                    
                    // Load data for section
                    if (section === 'setup-teams') renderSetupTeams();
                    if (section === 'import-entries') loadPoolsForImport();
                    if (section === 'manage-games') loadGames();
                    if (section === 'teams-status') loadTeamsStatus();
                    if (section === 'view-players') loadPlayersView();
                }
            });
        });

        // Game round tabs
        document.querySelectorAll('.tab[data-round]').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab[data-round]').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                loadGames(tab.dataset.round);
            });
        });

        // Modal functions
        function showAddGameModal() {
            populateTeamSelects();
            document.getElementById('addGameModal').classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function populateTeamSelects() {
            const selects = ['newGameAway', 'newGameHome', 'editGameAway', 'editGameHome'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Select team...</option>';
                    Object.entries(TEAMS).forEach(([abbr, team]) => {
                        select.innerHTML += `<option value="${abbr}">${abbr} - ${team.name}</option>`;
                    });
                    if (currentValue) select.value = currentValue;
                }
            });
            
            // Also populate View Players team filter
            const teamFilter = document.getElementById('viewPlayersTeam');
            if (teamFilter && teamFilter.options.length <= 1) {
                Object.entries(TEAMS).forEach(([abbr, team]) => {
                    teamFilter.innerHTML += `<option value="${abbr}">${abbr} - ${team.name}</option>`;
                });
            }
        }

        // =========================================
        // SCORING CALCULATION
        // =========================================
        function calculatePoints(stats) {
            let points = 0;
            
            // Passing: 1 pt per 25 yards (floor negative yards at 0)
            points += Math.floor(Math.max(0, stats.passYds || 0) / 25);
            // Passing TDs: 6 pts each
            points += (stats.passTD || 0) * 6;
            
            // Rushing: 1 pt per 10 yards (floor negative yards at 0)
            points += Math.floor(Math.max(0, stats.rushYds || 0) / 10);
            // Rushing TDs: 6 pts each
            points += (stats.rushTD || 0) * 6;
            
            // Receiving: 1 pt per 10 yards (floor negative yards at 0)
            points += Math.floor(Math.max(0, stats.recYds || 0) / 10);
            // Receiving TDs: 6 pts each
            points += (stats.recTD || 0) * 6;
            // PPR: 1 pt per reception
            points += (stats.rec || 0) * 1;
            
            // Kicking: FG ‚â§49 = 3 pts, FG 50+ = 5 pts
            points += (stats.fg || 0) * 3;
            points += (stats.fg50 || 0) * 5;
            // XP: 1 pt each
            points += (stats.xp || 0) * 1;
            
            // 2-pt conversions: 2 pts each
            points += (stats['2pt'] || 0) * 2;
            
            return points;
        }

        // =========================================
        // IMPORT PLAYERS
        // =========================================
        let playersToImport = [];

        function previewPlayers() {
            const csv = document.getElementById('playersCsv').value.trim();
            if (!csv) {
                alert('Please paste CSV data first');
                return;
            }

            const lines = csv.split('\n');
            const header = lines[0].toLowerCase().split(',').map(h => h.trim());
            
            // Find column indices
            const nameIdx = header.indexOf('name');
            const teamIdx = header.indexOf('team');
            const posIdx = header.indexOf('position') !== -1 ? header.indexOf('position') : header.indexOf('pos');
            
            if (nameIdx === -1 || teamIdx === -1 || posIdx === -1) {
                alert('CSV must have columns: name, team, position');
                return;
            }

            playersToImport = [];
            const tbody = document.getElementById('playersPreviewBody');
            tbody.innerHTML = '';

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const cols = lines[i].split(',').map(c => c.trim());
                const name = cols[nameIdx];
                const team = cols[teamIdx]?.toUpperCase();
                const position = cols[posIdx]?.toUpperCase();
                
                const isValidTeam = TEAMS[team];
                const isValidPos = ['QB', 'RB', 'WR', 'TE', 'K'].includes(position);
                const status = isValidTeam && isValidPos ? 'valid' : 'invalid';
                
                playersToImport.push({ name, team, position, status });
                
                tbody.innerHTML += `
                    <tr style="${status === 'invalid' ? 'color: var(--accent-red);' : ''}">
                        <td>${name}</td>
                        <td>${team} ${!isValidTeam ? '‚ö†Ô∏è' : ''}</td>
                        <td>${position} ${!isValidPos ? '‚ö†Ô∏è' : ''}</td>
                        <td>${status === 'valid' ? '‚úì' : '‚ö†Ô∏è Invalid'}</td>
                    </tr>
                `;
            }

            document.getElementById('playersPreviewCard').style.display = 'block';
            document.getElementById('playersPreviewCount').textContent = `${playersToImport.filter(p => p.status === 'valid').length} valid players`;
        }

        async function importPlayers() {
            const validPlayers = playersToImport.filter(p => p.status === 'valid');
            if (validPlayers.length === 0) {
                alert('No valid players to import');
                return;
            }

            if (!confirm(`Import ${validPlayers.length} players? This will add to existing players.`)) {
                return;
            }

            const resultDiv = document.getElementById('playersImportResult');
            resultDiv.innerHTML = '<div class="alert alert-info">Importing players...</div>';

            try {
                let imported = 0;
                for (const player of validPlayers) {
                    await db.collection('players').add({
                        name: player.name,
                        team: player.team,
                        teamName: TEAMS[player.team]?.name || player.team,
                        position: player.position,
                        active: true,
                        stats: {},
                        totalPoints: 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    imported++;
                }

                resultDiv.innerHTML = `<div class="alert alert-success">‚úì Successfully imported ${imported} players!</div>`;
                document.getElementById('playersCsv').value = '';
                document.getElementById('playersPreviewCard').style.display = 'none';
                playersToImport = [];

            } catch (error) {
                console.error('Import error:', error);
                resultDiv.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
            }
        }

        // =========================================
        // IMPORT STATS
        // =========================================
        let statsToImport = [];

        function previewStats() {
            const csv = document.getElementById('statsCsv').value.trim();
            if (!csv) {
                alert('Please paste CSV data first');
                return;
            }

            const lines = csv.split('\n');
            const header = lines[0].split(',').map(h => h.trim());
            
            // Find base column indices
            const nameIdx = header.findIndex(h => h.toLowerCase() === 'name');
            const teamIdx = header.findIndex(h => h.toLowerCase() === 'team');
            const posIdx = header.findIndex(h => h.toLowerCase() === 'position' || h.toLowerCase() === 'pos');
            
            if (nameIdx === -1 || teamIdx === -1) {
                alert('CSV must have columns: name, team');
                return;
            }

            // Find stat columns for each round
            const rounds = ['WC', 'DIV', 'CONF', 'SB'];
            const skillStatCols = ['passYds', 'passTD', 'rushYds', 'rushTD', 'rec', 'recYds', 'recTD', 'passing_yards', 'rushing_yards', 'receiving_yards', 'receptions', 'touchdowns', 'two_pt_conversions', '2pt'];
            const kickerStatCols = ['pat', 'fg_under_50', 'fg_50_plus', 'fg', 'fg50', 'xp'];
            
            statsToImport = [];
            const tbody = document.getElementById('statsPreviewBody');
            tbody.innerHTML = '';

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const cols = lines[i].split(',').map(c => c.trim());
                const name = cols[nameIdx];
                const team = cols[teamIdx]?.toUpperCase();
                const position = posIdx !== -1 ? cols[posIdx]?.toUpperCase() : '';
                const isKicker = position === 'K';
                
                const playerStats = { name, team, position, rounds: {} };
                
                // Parse each round's stats
                rounds.forEach(round => {
                    const roundStats = {};
                    
                    if (isKicker) {
                        // Parse kicker stats
                        kickerStatCols.forEach(stat => {
                            const colName = `${round}_${stat}`;
                            const colIdx = header.findIndex(h => h === colName || h.toLowerCase() === colName.toLowerCase());
                            if (colIdx !== -1 && cols[colIdx]) {
                                roundStats[stat] = parseInt(cols[colIdx]) || 0;
                            }
                        });
                        
                        if (Object.keys(roundStats).length > 0) {
                            // Normalize kicker stat names and calculate points
                            const xp = roundStats.pat || roundStats.xp || 0;
                            const fg = roundStats.fg_under_50 || roundStats.fg || 0;
                            const fg50 = roundStats.fg_50_plus || roundStats.fg50 || 0;
                            
                            roundStats.xp = xp;
                            roundStats.fg = fg;
                            roundStats.fg50 = fg50;
                            roundStats.points = (xp * 1) + (fg * 3) + (fg50 * 5);
                            playerStats.rounds[round] = roundStats;
                        }
                    } else {
                        // Parse skill position stats
                        skillStatCols.forEach(stat => {
                            const colName = `${round}_${stat}`;
                            const colIdx = header.findIndex(h => h === colName || h.toLowerCase() === colName.toLowerCase());
                            if (colIdx !== -1 && cols[colIdx]) {
                                roundStats[stat] = parseInt(cols[colIdx]) || 0;
                            }
                        });
                        
                        if (Object.keys(roundStats).length > 0) {
                            // Normalize stat names
                            roundStats.passYds = roundStats.passYds || roundStats.passing_yards || 0;
                            roundStats.rushYds = roundStats.rushYds || roundStats.rushing_yards || 0;
                            roundStats.recYds = roundStats.recYds || roundStats.receiving_yards || 0;
                            roundStats.rec = roundStats.rec || roundStats.receptions || 0;
                            roundStats.td = roundStats.td || roundStats.touchdowns || 0;
                            roundStats['2pt'] = roundStats['2pt'] || roundStats.two_pt_conversions || 0;
                            
                            roundStats.points = calculatePointsFromJson(roundStats);
                            playerStats.rounds[round] = roundStats;
                        }
                    }
                });

                // Calculate total points
                playerStats.totalPoints = Object.values(playerStats.rounds).reduce((sum, r) => sum + (r.points || 0), 0);
                
                statsToImport.push(playerStats);
                
                tbody.innerHTML += `
                    <tr>
                        <td>${name}</td>
                        <td>${team}</td>
                        <td>${position}</td>
                        <td>${playerStats.rounds.WC?.points || '-'}</td>
                        <td>${playerStats.rounds.DIV?.points || '-'}</td>
                        <td>${playerStats.rounds.CONF?.points || '-'}</td>
                        <td>${playerStats.rounds.SB?.points || '-'}</td>
                        <td style="font-weight: 600; color: var(--accent-gold);">${playerStats.totalPoints}</td>
                    </tr>
                `;
            }

            document.getElementById('statsPreviewCard').style.display = 'block';
            document.getElementById('statsPreviewCount').textContent = `${statsToImport.length} players parsed`;
        }

        async function importStats() {
            if (statsToImport.length === 0) {
                alert('No stats to import');
                return;
            }

            if (!confirm(`Update stats for ${statsToImport.length} players?`)) {
                return;
            }

            const resultDiv = document.getElementById('statsImportResult');
            resultDiv.innerHTML = '<div class="alert alert-info">Importing stats...</div>';

            try {
                let updated = 0;
                let notFound = 0;

                for (const playerStats of statsToImport) {
                    // Find player by name and team
                    const playersQuery = await db.collection('players')
                        .where('name', '==', playerStats.name)
                        .where('team', '==', playerStats.team)
                        .get();
                    
                    if (playersQuery.empty) {
                        notFound++;
                        continue;
                    }

                    const playerDoc = playersQuery.docs[0];
                    
                    // Update stats
                    await playerDoc.ref.update({
                        stats: playerStats.rounds,
                        totalPoints: playerStats.totalPoints,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    updated++;
                }

                let message = `‚úì Updated stats for ${updated} players.`;
                if (notFound > 0) {
                    message += ` ${notFound} players not found in database.`;
                }
                
                resultDiv.innerHTML = `<div class="alert alert-success">${message}</div>`;

            } catch (error) {
                console.error('Import error:', error);
                resultDiv.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
            }
        }

        // =========================================
        // IMPORT STATS FROM JSON
        // =========================================
        function previewStatsJson() {
            const fileInput = document.getElementById('statsJsonFile');
            if (!fileInput.files || !fileInput.files[0]) {
                alert('Please select a JSON file');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    processStatsJsonPreview(data);
                } catch (error) {
                    alert('Invalid JSON file: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        }

        function previewStatsJsonFromText() {
            const text = document.getElementById('statsJsonText').value.trim();
            if (!text) {
                alert('Please paste JSON data or upload a file');
                return;
            }

            try {
                const data = JSON.parse(text);
                processStatsJsonPreview(data);
            } catch (error) {
                alert('Invalid JSON: ' + error.message);
            }
        }

        function processStatsJsonPreview(data) {
            if (!Array.isArray(data)) {
                alert('JSON must be an array of player stats');
                return;
            }

            statsToImport = [];
            const tbody = document.getElementById('statsPreviewBody');
            tbody.innerHTML = '';

            const rounds = ['WC', 'DIV', 'CONF', 'SB'];

            data.forEach(player => {
                const playerStats = {
                    name: player.name,
                    team: player.team?.toUpperCase(),
                    position: player.position?.toUpperCase(),
                    rounds: {},
                    totalPoints: 0
                };

                // Parse each round's stats from JSON format
                rounds.forEach(round => {
                    const prefix = `${round}_`;
                    const isKicker = player.position?.toUpperCase() === 'K';
                    
                    let roundStats = {};
                    let hasData = false;
                    
                    if (isKicker) {
                        // Kicker stats: pat, fg_under_50, fg_50_plus
                        const pat = player[`${prefix}pat`] || 0;
                        const fgUnder50 = player[`${prefix}fg_under_50`] || 0;
                        const fg50Plus = player[`${prefix}fg_50_plus`] || 0;
                        
                        if (pat || fgUnder50 || fg50Plus) {
                            hasData = true;
                            roundStats = {
                                xp: pat,
                                fg: fgUnder50,
                                fg50: fg50Plus
                            };
                            // Calculate kicker points: 1 per XP, 3 per FG, 5 per FG 50+
                            roundStats.points = (pat * 1) + (fgUnder50 * 3) + (fg50Plus * 5);
                        }
                    } else {
                        // Skill position stats
                        const passYds = player[`${prefix}passing_yards`] || 0;
                        const rushYds = player[`${prefix}rushing_yards`] || 0;
                        const recYds = player[`${prefix}receiving_yards`] || 0;
                        const rec = player[`${prefix}receptions`] || 0;
                        const td = player[`${prefix}touchdowns`] || 0;
                        const twoPt = player[`${prefix}two_pt_conversions`] || 0;
                        
                        if (passYds || rushYds || recYds || rec || td || twoPt) {
                            hasData = true;
                            roundStats = {
                                passYds,
                                rushYds,
                                recYds,
                                rec,
                                td,
                                '2pt': twoPt
                            };
                            // Calculate points using scoring rules
                            roundStats.points = calculatePointsFromJson(roundStats);
                        }
                    }
                    
                    if (hasData) {
                        playerStats.rounds[round] = roundStats;
                    }
                });

                // Calculate total points from all rounds
                playerStats.totalPoints = Object.values(playerStats.rounds).reduce((sum, r) => sum + (r.points || 0), 0);

                statsToImport.push(playerStats);
                
                tbody.innerHTML += `
                    <tr>
                        <td>${playerStats.name}</td>
                        <td>${playerStats.team}</td>
                        <td>${playerStats.position}</td>
                        <td>${playerStats.rounds.WC?.points || '-'}</td>
                        <td>${playerStats.rounds.DIV?.points || '-'}</td>
                        <td>${playerStats.rounds.CONF?.points || '-'}</td>
                        <td>${playerStats.rounds.SB?.points || '-'}</td>
                        <td style="font-weight: 600; color: var(--accent-gold);">${playerStats.totalPoints}</td>
                    </tr>
                `;
            });

            document.getElementById('statsPreviewCard').style.display = 'block';
            document.getElementById('statsPreviewCount').textContent = `${statsToImport.length} players from JSON`;
        }

        // Calculate points for skill positions from JSON stats
        function calculatePointsFromJson(stats) {
            let points = 0;
            
            // Passing: 1 pt per 25 yards (floor negative yards at 0)
            points += Math.floor(Math.max(0, stats.passYds || 0) / 25);
            
            // Rushing: 1 pt per 10 yards (floor negative yards at 0)
            points += Math.floor(Math.max(0, stats.rushYds || 0) / 10);
            
            // Receiving: 1 pt per 10 yards (floor negative yards at 0)
            points += Math.floor(Math.max(0, stats.recYds || 0) / 10);
            
            // PPR: 1 pt per reception
            points += (stats.rec || 0) * 1;
            
            // Touchdowns: 6 pts each
            points += (stats.td || 0) * 6;
            
            // 2-pt conversions: 2 pts each
            points += (stats['2pt'] || 0) * 2;
            
            return points;
        }

        // =========================================
        // MANAGE GAMES
        // =========================================
        let currentGames = [];

        async function loadGames(roundFilter = 'all') {
            const container = document.getElementById('gamesContainer');
            container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Loading games...</p></div>';

            try {
                let query = db.collection('games').orderBy('gameDateTime', 'asc');
                const snapshot = await query.get();
                
                currentGames = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Filter by round if needed
                let filteredGames = currentGames;
                if (roundFilter !== 'all') {
                    filteredGames = currentGames.filter(g => g.round === roundFilter);
                }

                // Update stats
                document.getElementById('gamesCount').textContent = currentGames.length;
                document.getElementById('gamesUpcoming').textContent = currentGames.filter(g => g.status === 'upcoming').length;
                document.getElementById('gamesLocked').textContent = currentGames.filter(g => g.status === 'locked').length;
                document.getElementById('gamesFinal').textContent = currentGames.filter(g => g.status === 'final').length;

                if (filteredGames.length === 0) {
                    container.innerHTML = `
                        <div class="data-card">
                            <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                                <p style="font-size: 1.1rem; margin-bottom: 1rem;">üèà No games found</p>
                                <p style="font-size: 0.9rem;">Click "Add Game" to add playoff games</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = filteredGames.map(game => renderGameCard(game)).join('');

            } catch (error) {
                console.error('Error loading games:', error);
                container.innerHTML = '<div class="alert alert-error">Error loading games</div>';
            }
        }

        function renderGameCard(game) {
            const awayTeam = TEAMS[game.awayTeam] || { name: game.awayTeam };
            const homeTeam = TEAMS[game.homeTeam] || { name: game.homeTeam };
            const gameDate = game.gameDateTime?.toDate ? game.gameDateTime.toDate() : new Date(game.gameDateTime);
            const dateStr = gameDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            const timeStr = gameDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

            return `
                <div class="game-card" onclick="editGame('${game.id}')">
                    <div>
                        <div class="game-round">${ROUNDS[game.round] || game.round}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">${dateStr} ${timeStr}</div>
                    </div>
                    <div class="game-matchup">
                        <div class="game-team">
                            <div class="team-abbr">${game.awayTeam}</div>
                            <div class="team-name">${awayTeam.name}</div>
                            ${game.status === 'final' ? `<div style="font-family: Oswald; font-size: 1.25rem; margin-left: 0.5rem;">${game.awayScore || 0}</div>` : ''}
                        </div>
                        <div class="game-vs">@</div>
                        <div class="game-team">
                            <div class="team-abbr">${game.homeTeam}</div>
                            <div class="team-name">${homeTeam.name}</div>
                            ${game.status === 'final' ? `<div style="font-family: Oswald; font-size: 1.25rem; margin-left: 0.5rem;">${game.homeScore || 0}</div>` : ''}
                        </div>
                    </div>
                    <div class="game-lines">
                        ${game.awaySpread ? `
                            <div class="game-line">
                                <div class="game-line-label">Spread</div>
                                <div class="game-line-value">${game.awaySpread}</div>
                            </div>
                        ` : ''}
                        ${game.total ? `
                            <div class="game-line">
                                <div class="game-line-label">O/U</div>
                                <div class="game-line-value">${game.total}</div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="game-status ${game.status}">${game.status}</div>
                </div>
            `;
        }

        async function saveGame() {
            const round = document.getElementById('newGameRound').value;
            const dateTime = document.getElementById('newGameDateTime').value;
            const awayTeam = document.getElementById('newGameAway').value;
            const homeTeam = document.getElementById('newGameHome').value;
            
            if (!dateTime || !awayTeam || !homeTeam) {
                alert('Please fill in round, date/time, and both teams');
                return;
            }

            try {
                await db.collection('games').add({
                    round,
                    gameDateTime: new Date(dateTime),
                    awayTeam,
                    awayName: TEAMS[awayTeam]?.name || awayTeam,
                    homeTeam,
                    homeName: TEAMS[homeTeam]?.name || homeTeam,
                    awaySpread: document.getElementById('newGameAwaySpread').value || null,
                    homeSpread: document.getElementById('newGameHomeSpread').value || null,
                    awayML: document.getElementById('newGameAwayML').value || null,
                    homeML: document.getElementById('newGameHomeML').value || null,
                    total: document.getElementById('newGameTotal').value || null,
                    status: document.getElementById('newGameStatus').value || 'upcoming',
                    awayScore: null,
                    homeScore: null,
                    winner: null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                closeModal('addGameModal');
                loadGames();
                
                // Clear form
                document.getElementById('newGameAway').value = '';
                document.getElementById('newGameHome').value = '';
                document.getElementById('newGameAwaySpread').value = '';
                document.getElementById('newGameHomeSpread').value = '';
                document.getElementById('newGameAwayML').value = '';
                document.getElementById('newGameHomeML').value = '';
                document.getElementById('newGameTotal').value = '';

            } catch (error) {
                console.error('Error saving game:', error);
                alert('Error saving game: ' + error.message);
            }
        }

        function editGame(gameId) {
            const game = currentGames.find(g => g.id === gameId);
            if (!game) return;

            populateTeamSelects();
            
            document.getElementById('editGameId').value = gameId;
            document.getElementById('editGameRound').value = game.round;
            
            const dt = game.gameDateTime?.toDate ? game.gameDateTime.toDate() : new Date(game.gameDateTime);
            document.getElementById('editGameDateTime').value = dt.toISOString().slice(0, 16);
            
            document.getElementById('editGameAway').value = game.awayTeam;
            document.getElementById('editGameHome').value = game.homeTeam;
            document.getElementById('editGameAwaySpread').value = game.awaySpread || '';
            document.getElementById('editGameHomeSpread').value = game.homeSpread || '';
            document.getElementById('editGameAwayML').value = game.awayML || '';
            document.getElementById('editGameHomeML').value = game.homeML || '';
            document.getElementById('editGameTotal').value = game.total || '';
            document.getElementById('editGameStatus').value = game.status || 'upcoming';
            document.getElementById('editGameAwayScore').value = game.awayScore || '';
            document.getElementById('editGameHomeScore').value = game.homeScore || '';

            document.getElementById('editGameModal').classList.add('active');
        }

        async function updateGame() {
            const gameId = document.getElementById('editGameId').value;
            const awayTeam = document.getElementById('editGameAway').value;
            const homeTeam = document.getElementById('editGameHome').value;
            const awayScore = document.getElementById('editGameAwayScore').value;
            const homeScore = document.getElementById('editGameHomeScore').value;
            const status = document.getElementById('editGameStatus').value;

            // Determine winner if final
            let winner = null;
            if (status === 'final' && awayScore && homeScore) {
                const away = parseInt(awayScore);
                const home = parseInt(homeScore);
                winner = away > home ? awayTeam : homeTeam;
            }

            try {
                await db.collection('games').doc(gameId).update({
                    round: document.getElementById('editGameRound').value,
                    gameDateTime: new Date(document.getElementById('editGameDateTime').value),
                    awayTeam,
                    awayName: TEAMS[awayTeam]?.name || awayTeam,
                    homeTeam,
                    homeName: TEAMS[homeTeam]?.name || homeTeam,
                    awaySpread: document.getElementById('editGameAwaySpread').value || null,
                    homeSpread: document.getElementById('editGameHomeSpread').value || null,
                    awayML: document.getElementById('editGameAwayML').value || null,
                    homeML: document.getElementById('editGameHomeML').value || null,
                    total: document.getElementById('editGameTotal').value || null,
                    status,
                    awayScore: awayScore ? parseInt(awayScore) : null,
                    homeScore: homeScore ? parseInt(homeScore) : null,
                    winner,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // If game is final, mark losing team as eliminated
                if (status === 'final' && winner) {
                    const loser = winner === awayTeam ? homeTeam : awayTeam;
                    await updateTeamElimination(loser, true);
                }

                closeModal('editGameModal');
                loadGames();

            } catch (error) {
                console.error('Error updating game:', error);
                alert('Error updating game: ' + error.message);
            }
        }

        async function deleteGame() {
            const gameId = document.getElementById('editGameId').value;
            if (!confirm('Delete this game? This cannot be undone.')) return;

            try {
                await db.collection('games').doc(gameId).delete();
                closeModal('editGameModal');
                loadGames();
            } catch (error) {
                console.error('Error deleting game:', error);
                alert('Error deleting game: ' + error.message);
            }
        }

        // =========================================
        // TEAMS STATUS
        // =========================================
        let teamsStatus = {};

        async function loadTeamsStatus() {
            try {
                // Reload teams to get latest eliminated status
                await loadPlayoffTeams();
                
                // Use TEAMS directly since it now includes eliminated status
                teamsStatus = { ...TEAMS };
                
                renderTeamsStatus();
            } catch (error) {
                console.error('Error loading teams:', error);
            }
        }

        function renderTeamsStatus() {
            const afcContainer = document.getElementById('afcTeams');
            const nfcContainer = document.getElementById('nfcTeams');
            
            if (Object.keys(TEAMS).length === 0) {
                afcContainer.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">No teams loaded. Go to Setup Teams first.</p>';
                nfcContainer.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">No teams loaded. Go to Setup Teams first.</p>';
                document.getElementById('teamsActive').textContent = 0;
                document.getElementById('teamsEliminated').textContent = 0;
                return;
            }
            
            const afcTeams = Object.entries(TEAMS)
                .filter(([_, t]) => t.conference === 'AFC')
                .sort((a, b) => a[1].seed - b[1].seed);
            const nfcTeams = Object.entries(TEAMS)
                .filter(([_, t]) => t.conference === 'NFC')
                .sort((a, b) => a[1].seed - b[1].seed);

            let activeCount = 0;

            afcContainer.innerHTML = afcTeams.map(([abbr, team]) => {
                const eliminated = team.eliminated || false;
                if (!eliminated) activeCount++;
                return renderTeamCard(abbr, team, eliminated);
            }).join('');

            nfcContainer.innerHTML = nfcTeams.map(([abbr, team]) => {
                const eliminated = team.eliminated || false;
                if (!eliminated) activeCount++;
                return renderTeamCard(abbr, team, eliminated);
            }).join('');

            document.getElementById('teamsActive').textContent = activeCount;
            document.getElementById('teamsEliminated').textContent = Object.keys(TEAMS).length - activeCount;
        }

        function renderTeamCard(abbr, team, eliminated) {
            return `
                <div class="team-card ${eliminated ? 'eliminated' : ''}">
                    <div class="team-logo">${abbr}</div>
                    <div class="team-info">
                        <div class="team-card-name">${team.name}</div>
                        <div class="team-card-conf">${team.conference} #${team.seed}</div>
                    </div>
                    <div class="team-toggle ${!eliminated ? 'active' : ''}" onclick="toggleTeam('${abbr}', ${!eliminated})"></div>
                </div>
            `;
        }

        async function toggleTeam(abbr, currentlyActive) {
            await updateTeamElimination(abbr, currentlyActive);
            loadTeamsStatus();
        }

        async function updateTeamElimination(abbr, eliminated) {
            try {
                const teamRef = db.collection('teams').doc(abbr);
                const doc = await teamRef.get();
                
                if (doc.exists) {
                    await teamRef.update({ eliminated });
                } else {
                    await teamRef.set({
                        ...TEAMS[abbr],
                        eliminated
                    });
                }
            } catch (error) {
                console.error('Error updating team:', error);
            }
        }

        async function resetAllTeams() {
            if (!confirm('Reset all teams to active? This will mark all 14 teams as not eliminated.')) return;

            try {
                for (const abbr of Object.keys(TEAMS)) {
                    await updateTeamElimination(abbr, false);
                }
                loadTeamsStatus();
            } catch (error) {
                console.error('Error resetting teams:', error);
            }
        }

        // =========================================
        // VIEW PLAYERS
        // =========================================
        let currentPlayersView = [];

        async function loadPlayersView() {
            const teamFilter = document.getElementById('viewPlayersTeam').value;
            const posFilter = document.getElementById('viewPlayersPos').value;
            const tbody = document.getElementById('playersViewBody');

            tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 2rem;">Loading...</td></tr>';

            try {
                let query = db.collection('players').orderBy('name');
                const snapshot = await query.get();
                
                currentPlayersView = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                let players = [...currentPlayersView];
                
                // Apply filters
                if (teamFilter !== 'all') {
                    players = players.filter(p => p.team === teamFilter);
                }
                if (posFilter !== 'all') {
                    players = players.filter(p => p.position === posFilter);
                }

                // Update counts
                document.getElementById('playersCount').textContent = currentPlayersView.length;
                document.getElementById('playersQB').textContent = currentPlayersView.filter(p => p.position === 'QB').length;
                document.getElementById('playersRB').textContent = currentPlayersView.filter(p => p.position === 'RB').length;
                document.getElementById('playersWR').textContent = currentPlayersView.filter(p => p.position === 'WR').length;
                document.getElementById('playersTE').textContent = currentPlayersView.filter(p => p.position === 'TE').length;
                document.getElementById('playersK').textContent = currentPlayersView.filter(p => p.position === 'K').length;

                if (players.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 2rem; color: var(--text-muted);">No players found</td></tr>';
                    return;
                }

                tbody.innerHTML = players.map(player => {
                    const stats = player.stats || {};
                    const isIR = player.ir || player.status === 'ir';
                    const teamEliminated = TEAMS[player.team]?.eliminated;
                    
                    let statusBadge = '';
                    if (isIR) {
                        statusBadge = '<span style="background: var(--accent-red); color: white; padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">IR</span>';
                    } else if (teamEliminated) {
                        statusBadge = '<span style="background: var(--text-muted); color: white; padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">ELIM</span>';
                    } else {
                        statusBadge = '<span style="background: var(--accent-green); color: white; padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Active</span>';
                    }
                    
                    const rowStyle = isIR ? 'opacity: 0.6;' : (teamEliminated ? 'opacity: 0.7;' : '');
                    
                    return `
                        <tr style="${rowStyle}">
                            <td>${player.name}</td>
                            <td>${player.team}</td>
                            <td>${player.position}</td>
                            <td>${statusBadge}</td>
                            <td>${stats.WC?.points || '-'}</td>
                            <td>${stats.DIV?.points || '-'}</td>
                            <td>${stats.CONF?.points || '-'}</td>
                            <td>${stats.SB?.points || '-'}</td>
                            <td style="font-weight: 600; color: var(--accent-gold);">${player.totalPoints || 0}</td>
                            <td>
                                <button class="btn btn-outline btn-sm" onclick="editPlayer('${player.id}')" title="Edit">‚úèÔ∏è</button>
                                <button class="btn btn-outline btn-sm" onclick="deletePlayer('${player.id}')" title="Delete">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading players:', error);
                tbody.innerHTML = '<tr><td colspan="10" style="color: var(--accent-red);">Error loading players</td></tr>';
            }
        }

        function editPlayer(playerId) {
            const player = currentPlayersView.find(p => p.id === playerId);
            if (!player) return;

            // Populate team select
            const teamSelect = document.getElementById('editPlayerTeam');
            teamSelect.innerHTML = '<option value="">Select team...</option>';
            Object.entries(TEAMS).forEach(([abbr, team]) => {
                teamSelect.innerHTML += `<option value="${abbr}">${abbr} - ${team.name}</option>`;
            });

            document.getElementById('editPlayerId').value = playerId;
            document.getElementById('editPlayerName').value = player.name || '';
            document.getElementById('editPlayerTeam').value = player.team || '';
            document.getElementById('editPlayerPosition').value = player.position || 'QB';
            document.getElementById('editPlayerIR').checked = player.ir || player.status === 'ir';

            // Load stats into form
            const stats = player.stats || {};
            const rounds = ['WC', 'DIV', 'CONF', 'SB'];
            const isKicker = player.position === 'K';
            
            // Clear all stat fields first
            rounds.forEach(round => {
                // Skill stats
                ['passYds', 'rushYds', 'recYds', 'rec', 'td', '2pt'].forEach(stat => {
                    const el = document.getElementById(`editStats_${round}_${stat}`);
                    if (el) el.value = '';
                });
                // Kicker stats
                ['xp', 'fg', 'fg50'].forEach(stat => {
                    const el = document.getElementById(`editStats_${round}_${stat}`);
                    if (el) el.value = '';
                });
            });
            
            // Populate stats
            rounds.forEach(round => {
                const roundStats = stats[round] || {};
                
                if (isKicker) {
                    document.getElementById(`editStats_${round}_xp`).value = roundStats.xp || '';
                    document.getElementById(`editStats_${round}_fg`).value = roundStats.fg || '';
                    document.getElementById(`editStats_${round}_fg50`).value = roundStats.fg50 || '';
                } else {
                    document.getElementById(`editStats_${round}_passYds`).value = roundStats.passYds || '';
                    document.getElementById(`editStats_${round}_rushYds`).value = roundStats.rushYds || '';
                    document.getElementById(`editStats_${round}_recYds`).value = roundStats.recYds || '';
                    document.getElementById(`editStats_${round}_rec`).value = roundStats.rec || '';
                    document.getElementById(`editStats_${round}_td`).value = roundStats.td || '';
                    document.getElementById(`editStats_${round}_2pt`).value = roundStats['2pt'] || '';
                }
            });
            
            // Show/hide appropriate stats fields
            toggleStatsFields();
            
            // Calculate displayed points
            recalculateEditStats();

            document.getElementById('editPlayerModal').classList.add('active');
        }

        function toggleStatsFields() {
            const position = document.getElementById('editPlayerPosition').value;
            const isKicker = position === 'K';
            
            document.getElementById('skillStatsFields').style.display = isKicker ? 'none' : 'block';
            document.getElementById('kickerStatsFields').style.display = isKicker ? 'block' : 'none';
            
            recalculateEditStats();
        }

        function recalculateEditStats() {
            const position = document.getElementById('editPlayerPosition').value;
            const isKicker = position === 'K';
            const rounds = ['WC', 'DIV', 'CONF', 'SB'];
            let totalPoints = 0;
            
            rounds.forEach(round => {
                let pts = 0;
                
                if (isKicker) {
                    const xp = parseInt(document.getElementById(`editStats_${round}_xp`).value) || 0;
                    const fg = parseInt(document.getElementById(`editStats_${round}_fg`).value) || 0;
                    const fg50 = parseInt(document.getElementById(`editStats_${round}_fg50`).value) || 0;
                    
                    pts = (xp * 1) + (fg * 3) + (fg50 * 5);
                    document.getElementById(`editStats_${round}_kpts`).textContent = pts;
                } else {
                    const passYds = parseInt(document.getElementById(`editStats_${round}_passYds`).value) || 0;
                    const rushYds = parseInt(document.getElementById(`editStats_${round}_rushYds`).value) || 0;
                    const recYds = parseInt(document.getElementById(`editStats_${round}_recYds`).value) || 0;
                    const rec = parseInt(document.getElementById(`editStats_${round}_rec`).value) || 0;
                    const td = parseInt(document.getElementById(`editStats_${round}_td`).value) || 0;
                    const twoPt = parseInt(document.getElementById(`editStats_${round}_2pt`).value) || 0;
                    
                    pts = Math.floor(Math.max(0, passYds) / 25) +
                          Math.floor(Math.max(0, rushYds) / 10) +
                          Math.floor(Math.max(0, recYds) / 10) +
                          rec + (td * 6) + (twoPt * 2);
                    
                    document.getElementById(`editStats_${round}_pts`).textContent = pts;
                }
                
                totalPoints += pts;
            });
            
            document.getElementById('editStatsTotalPts').textContent = totalPoints;
        }

        async function updatePlayer() {
            const playerId = document.getElementById('editPlayerId').value;
            const name = document.getElementById('editPlayerName').value.trim();
            const team = document.getElementById('editPlayerTeam').value;
            const position = document.getElementById('editPlayerPosition').value;
            const ir = document.getElementById('editPlayerIR').checked;

            if (!name || !team) {
                alert('Please fill in name and team');
                return;
            }

            // Build stats object
            const rounds = ['WC', 'DIV', 'CONF', 'SB'];
            const isKicker = position === 'K';
            const stats = {};
            let totalPoints = 0;
            
            rounds.forEach(round => {
                const roundStats = {};
                let pts = 0;
                
                if (isKicker) {
                    roundStats.xp = parseInt(document.getElementById(`editStats_${round}_xp`).value) || 0;
                    roundStats.fg = parseInt(document.getElementById(`editStats_${round}_fg`).value) || 0;
                    roundStats.fg50 = parseInt(document.getElementById(`editStats_${round}_fg50`).value) || 0;
                    
                    pts = (roundStats.xp * 1) + (roundStats.fg * 3) + (roundStats.fg50 * 5);
                } else {
                    roundStats.passYds = parseInt(document.getElementById(`editStats_${round}_passYds`).value) || 0;
                    roundStats.rushYds = parseInt(document.getElementById(`editStats_${round}_rushYds`).value) || 0;
                    roundStats.recYds = parseInt(document.getElementById(`editStats_${round}_recYds`).value) || 0;
                    roundStats.rec = parseInt(document.getElementById(`editStats_${round}_rec`).value) || 0;
                    roundStats.td = parseInt(document.getElementById(`editStats_${round}_td`).value) || 0;
                    roundStats['2pt'] = parseInt(document.getElementById(`editStats_${round}_2pt`).value) || 0;
                    
                    pts = Math.floor(Math.max(0, roundStats.passYds) / 25) +
                          Math.floor(Math.max(0, roundStats.rushYds) / 10) +
                          Math.floor(Math.max(0, roundStats.recYds) / 10) +
                          roundStats.rec + (roundStats.td * 6) + (roundStats['2pt'] * 2);
                }
                
                roundStats.points = pts;
                totalPoints += pts;
                
                // Only add round if there are any stats
                if (Object.values(roundStats).some(v => v !== 0)) {
                    stats[round] = roundStats;
                }
            });

            try {
                await db.collection('players').doc(playerId).update({
                    name,
                    team,
                    teamName: TEAMS[team]?.name || team,
                    position,
                    ir,
                    status: ir ? 'ir' : 'active',
                    stats,
                    totalPoints,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                closeModal('editPlayerModal');
                loadPlayersView();
            } catch (error) {
                console.error('Error updating player:', error);
                alert('Error updating player: ' + error.message);
            }
        }

        // Recalculate all player points from stored stats
        async function recalculateAllPoints() {
            if (!confirm('Recalculate points for ALL players from their stored stats? This will update all point values.')) return;
            
            const resultDiv = document.createElement('div');
            resultDiv.className = 'alert alert-info';
            resultDiv.textContent = 'Recalculating points...';
            document.querySelector('#view-players .page-header').after(resultDiv);
            
            try {
                const snapshot = await db.collection('players').get();
                let updated = 0;
                let errors = 0;
                
                for (const doc of snapshot.docs) {
                    const player = doc.data();
                    const stats = player.stats || {};
                    const isKicker = player.position === 'K';
                    let totalPoints = 0;
                    const updatedStats = {};
                    
                    ['WC', 'DIV', 'CONF', 'SB'].forEach(round => {
                        if (stats[round]) {
                            const roundStats = { ...stats[round] };
                            let pts = 0;
                            
                            if (isKicker) {
                                pts = ((roundStats.xp || 0) * 1) + 
                                      ((roundStats.fg || 0) * 3) + 
                                      ((roundStats.fg50 || 0) * 5);
                            } else {
                                pts = Math.floor(Math.max(0, roundStats.passYds || 0) / 25) +
                                      Math.floor(Math.max(0, roundStats.rushYds || 0) / 10) +
                                      Math.floor(Math.max(0, roundStats.recYds || 0) / 10) +
                                      (roundStats.rec || 0) + 
                                      ((roundStats.td || 0) * 6) + 
                                      ((roundStats['2pt'] || 0) * 2);
                            }
                            
                            roundStats.points = pts;
                            totalPoints += pts;
                            updatedStats[round] = roundStats;
                        }
                    });
                    
                    try {
                        await doc.ref.update({
                            stats: updatedStats,
                            totalPoints,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        updated++;
                    } catch (e) {
                        errors++;
                        console.error('Error updating player:', doc.id, e);
                    }
                }
                
                resultDiv.className = 'alert alert-success';
                resultDiv.textContent = `‚úì Recalculated points for ${updated} players.${errors > 0 ? ` ${errors} errors.` : ''}`;
                
                // Refresh the view
                loadPlayersView();
                
                // Remove alert after 5 seconds
                setTimeout(() => resultDiv.remove(), 5000);
                
            } catch (error) {
                console.error('Recalculation error:', error);
                resultDiv.className = 'alert alert-error';
                resultDiv.textContent = 'Error: ' + error.message;
            }
        }

        function deletePlayerFromEdit() {
            const playerId = document.getElementById('editPlayerId').value;
            if (!confirm('Delete this player? This cannot be undone.')) return;
            
            deletePlayer(playerId);
            closeModal('editPlayerModal');
        }

        async function deletePlayer(playerId) {
            if (!confirm('Delete this player?')) return;

            try {
                await db.collection('players').doc(playerId).delete();
                loadPlayersView();
            } catch (error) {
                console.error('Error deleting player:', error);
                alert('Error: ' + error.message);
            }
        }

        // =========================================
        // AUTH CHECK
        // =========================================
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'home.html';
                return;
            }

            // Check if admin
            const userDoc = await db.collection('users').doc(user.uid).get();
            if (!userDoc.exists || userDoc.data().role !== 'admin') {
                alert('Access denied. Admin privileges required.');
                window.location.href = 'home.html';
                return;
            }

            // Initialize - Load teams first, then populate selects
            await loadPlayoffTeams();
            populateTeamSelects();
            
            // Add event listeners for stats inputs to auto-recalculate
            const statsInputs = document.querySelectorAll('[id^="editStats_"]');
            statsInputs.forEach(input => {
                if (input.tagName === 'INPUT') {
                    input.addEventListener('input', recalculateEditStats);
                }
            });
        });
    </script>
</body>
</html>
